---
title: "Exploring possible causes of seasonality in DI applications"
output:
  pdf_document:
    includes:
      in_header: LatexPreamble.sty
    number_sections: yes
editor_options: 
  chunk_output_type: console
---

```{r preamble, include=FALSE}

library(plyr)
library(ggplot2)
library(scales)
#library(xtable)
#library(DataCombine) # it loads dplyr!
library(magrittr)
library("tidyr")
library("knitr")
library(lubridate)
library(tsibble)
library(fable)
library(feasts)
library(dplyr)
library(purrr)
library(grid)
library(gridExtra)
library(magrittr)
library(stargazer)
library(plm)
library(glue)

options(xtable.include.rownames = F,
        xtable.booktabs = T,
        xtable.caption.placement = "top")

options(dplyr.print_max = 50)
options(tibble.print_max = 50, tibble.print_min = 50)

source("General.R")
select <- dplyr::select

plot.path = "paper_plot/"
dir.fig_newVer = "paper_plot/fig_newVer/"


# Population versions for variance and standard deviation
pop.var <- function(x,...) var(x, ...) * (length(x)-1) / length(x)
pop.sd  <- function(x,...) sqrt(pop.var(x, ...))
msd1    <- function(x,...) sqrt(sum((x - 1)^2)/length(x))



##' This analysis depends on the following inputs
# 
#'   1. Data/intermed_ets.rds (generated by Seasonality.Pattern.Rmd - modeling seasonality)
#'        - A list containing the following elements
#           - Panel_all: Panel data up to the most recent date
#'          - Panel:     Panel data up to Feb 2020
#'          - mod_ets:   ets model results for all variables of interest
#'          - df_comp_ets: decomposed time series extracted from mod_ets
#
#'   2. Data/emplyIndustry.RData (generated by Data.import.BEA.R)
#'        - df_emplyInd: annual employment data by industry and state
#'          (no national, need to generate in this script)
#
#'   3. Data/temperature.RData (generated by Data.import.temperature.R)
#'        - df_temperature: monthly average temperature (F) by state 
#'          (national for contiguous 48 states)


ls_ets <- readRDS("Data/intermed_ets.rds")
(load("Data/emplyIndustry.RData")) # df_emplyInd
(load("Data/temperature.RData"))   # df_temperature   


```


## Preparing temperature and employment structure data for regression
```{r include=FALSE}

# Prep 1: temperature 
#   - calculate average monthly temperature from 2000-2020
#   - output: 49 states excluding Hawaii, and national (48 contiguous states) (50 regions in total)

df_temp_monAvg <- 
  df_temerature %>% 
  filter(year %in% 2000:2020) %>% 
  group_by(state_abb, month) %>% 
  summarise(tempF = mean(tempF, na.rm = TRUE),
            .groups = "drop_last") %>% 
  rename(State = state_abb,
         Month = month)

df_temp_yrAvg <- 
  df_temp_monAvg %>% 
  group_by(State) %>% 
  summarise(tempF_sd = pop.sd(tempF, na.rm = TRUE),
            tempF = mean(tempF, na.rm = TRUE)
            )
#df_temp_yrAvg   

# Prep 1.1 seasonal factors for monthly temperature




# Prep 2: employment by industry and state
#   - Create the following variables
#     - emply_leisure: emply_accomm + emply_entertain
#     - emply_highSea5:   emply_construction + emply_retail + emply_gov + emply_leisure + emply mining
#     - emply_modestSea4: emply_highSea5 excluding construction
#   - Also create shares in total employment for the following vars
#     - emply_construction, emply_retail, emply_gov,  emply_leisure, emply mining
#     - emply_highSea5, emply_modestSea4,
#     - emply_farm
#
#   - Create a new data frame containing mean shares (across 2000-2020) of key variables 
#   - Output contains 50 states + DC + national (52 regions)


df_emplyInd %<>% 
  mutate(emply_leisure    = emply_accomm + emply_entertain,
         emply_highSea5   = emply_construction + emply_retail + emply_gov + emply_leisure + emply_mining,
         emply_modestSea4 = emply_highSea5 - emply_construction,
         
         emplyShare_construction = emply_construction / emply_Tot,
         emplyShare_retail       = emply_retail/ emply_Tot,
         emplyShare_gov          = emply_gov/ emply_Tot,
         emplyShare_leisure      = emply_leisure/ emply_Tot, 
         emplyShare_mining       = emply_mining / emply_Tot,
         emplyShare_highSea5     = emply_highSea5/ emply_Tot, 
         emplyShare_modestSea4   = emply_modestSea4/ emply_Tot,
         emplyShare_farm         = emply_farm/ emply_Tot
         )

# Average shares from 2000 to 2020
df_emplyInd_share <-
  df_emplyInd %>% 
  filter(year %in% 2000:2020) %>% 
  group_by(State) %>% 
  summarise(across(starts_with("emplyShare"), ~ mean(.x, na.rm = TRUE)))

# df_emplyInd_share$State %>% unique() %>% length

```



# Regression: strengh of seasonality

This section explore the determinants of the strength of seasonality (measured by SD seasonal factor)

We consider the following RHS variables:

- Seasonal strength of unemployment 
   - unemployment (unemply)
   - or, dunemply, dlunemply
- Temperature
- Industrial structure measures
  - share of construction
  - share of highest 5
  - share of modest 4
  - share of farm

In theory, the impact of industrial structure should be already reflected in the strength of unemployment 



## - Computing seasonal strength

```{r include=FALSE}

# Computing seasonal strength measures in two ways
#   1. Variance-based measure
#       - https://otexts.com/fpp3/stlfeatures.html
#       - max(0, Var(residual) / var(season + residual) )
#   2. SD of average seasonal factor (similar to Geremew & Gourio(2018))
#       - Calculate average seasonal factor across years (season)
#       - Standard deviation (w/ denominator n) of the average seasonal factors
# 
# 
# Note that these two seasonal strength measures serve different purposes
#   - The variance-based measure. It measures how the seasonal variation compares to
#     the detrended variation. It demonstrates the relative importance of the seasonal
#     varation in the overall detrended variation
#   - SD of seasonal factors. This measure does not involve any comparison with other
#     component of the series. Rather, it measures the overall magnitude of the seasonal
#     component itself.
# 
#   - This two measures may NOT be correlated. For example, a series may have a
#     prominent seasonal pattern (high SD seasonal factor), but the seasonal variation
#     may only account for a small proportion of the overall (detrended) variation due to
#     a highly volatile residual (error) component.
# 
#   - For the paper
#      -  The first measure can be used to justify the importance of seasonality
#      -  The second one is more appropriate to use in the regression analysis. (as did in GG(2018))

# Outputs:
#   - 50 states + national (US) + 10 SSA regions (61 grps in total) 





# x <- 
# ls_ets$df_comp_ets %>% 
#   filter(.model == "emplyMon_mining")

# 1. variace based measure
df_seaStr_var <- 
  ls_ets$df_comp_ets %>% 
  as_tibble %>% 
  filter(!is.na(remainder), !is.na(season)) %>% 
  group_by(State, .model) %>% 
  summarise(var_SR = pop.var(season * (1 + remainder), na.rm = TRUE),
            var_R  = pop.var( log(1 + remainder), na.rm = TRUE),
            
            var_LBR = pop.var(y / season, na.rm = TRUE),
            var_y   = pop.var(y, na.rm = TRUE),
            
            # log version
            var_lnSR = pop.var(log(season) + log(1 + remainder), na.rm = TRUE),
            var_lnR  = pop.var( log(1 + remainder), na.rm = TRUE),
            
            var_lnLBR = pop.var(log(y) - log(season), na.rm = TRUE),
            var_lny   = pop.var(log(y), na.rm = TRUE),
            
            
            
            .groups = "drop") %>% 
  mutate(seaStr_var  = pmax(0, 1 - var_R/var_SR),
         seaStr_var2 = pmax(0, 1 - var_LBR/var_y),
         
         seaStr_var.ln  = pmax(0, 1 - var_lnR/var_lnSR),
         seaStr_var2.ln = pmax(0, 1 - var_lnLBR/var_lny)
         
         
         )



# 2. SD of average seasonal factor
df_seaStr_gg <- 
  ls_ets$df_comp_ets %>% 
  as_tibble %>% 
  filter(!is.na(remainder), !is.na(season)) %>% 
  mutate(month = month(date_yearmon)) %>% 
  group_by(State, .model, month) %>% 
  # average seasonal factors across years
  summarise(season_avg = mean(season, na.rm = TRUE), .groups = "drop_last") %>% 
  # SD (pop) of seasonal factors across month
  summarise(seaStr_gg  = pop.sd(season_avg), .groups = "drop",
            seaStr_gg1 = msd1(season_avg))
 

# merging measures
df_seaStr <- 
  left_join(df_seaStr_var, df_seaStr_gg, by = c("State", ".model"))
  

## Check if the two measures are correlated 
# x <- df_seaStr %>% 
#   group_by(.model) %>% 
#   summarise(str_corr = cor(seaStr_var, seaStr_gg))
# x

# Modereate correlation for unemployment and UI
# Little or week correlation for DI variables. 
# Almost no correlation for DI applications.

# df_seaStr$State %>% unique()
# x <- ls_ets$df_comp_ets %>% 
#   filter(.model == "dlemplyMon_construction")
# 
# df_seaStr %>% filter(.model == "dlemplyMon_construction")
```




## - **paper**: Tables for seasonal strength

```{r}

df_seaStr_var_tbl <- 
  df_seaStr_var %>% 
  select(State, .model, starts_with("seaStr")) %>% 
  filter(.model %in% c("SSDI", "SSI", "conc", "UIIC",  "unemply")) %>% 
  mutate(.model = factor(.model, c("SSDI", "SSI", "conc", "UIIC", "unemply"))) %>% 
  arrange(State, .model)

df_seaStr_gg_tbl <- 
  df_seaStr_gg %>% 
  select(State, .model, starts_with("seaStr")) %>% 
  filter(.model %in% c("SSDI", "SSI", "conc", "UIIC",  "unemply")) %>% 
  mutate(.model = factor(.model, c("SSDI", "SSI", "conc", "UIIC", "unemply"))) %>% 
  arrange(State, .model)
  




## Table showing var-based seasonal strength for US total

df_seaStr_var_tbl %>% 
  filter(State == "US+")

df_seaStr_var_tbl %>% 
  filter(State == "US")

tbl_seaStr_var_US <- 
  df_seaStr_var_tbl %>% 
  filter(State == "US+") %>% 
  select(.model, seaStr_var, seaStr_var2) %>% 
  mutate(.model = factor(.model, levels = c("SSDI", "SSI", "conc", "UIIC", "unemply"),
                                 labels = c("SSDI", "SSI", "Concurrent", "UI Initial", "Unemployment"))) %>% 
  gt %>% 
  cols_label(
    .model = "",
    seaStr_var  = "without trend",
    seaStr_var2 = "with trend"
  ) %>% 
  tab_spanner(
    label = "Seasonal strength with respect to series",
    columns = c(
      seaStr_var,  
 seaStr_var2 )
  ) %>% 
  fmt_number(columns = 2:3,
             decimals = 2)
tbl_seaStr_var_US
  


## Variation of var-based measure across states: bar plot

library(forcats)

# Plot for SSDI
df_seaStr_var_tbl %>% 
  filter(.model == "SSDI",
         State %in% state.abb) %>% 
  arrange(desc(seaStr_var)) %>% 
  mutate(State = factor(State) %>% fct_inorder) %>% 
  ggplot(aes(x = State, y = seaStr_var)) + theme_bw() + 
  geom_bar(stat = "identity", fill = "dodgerblue4", width = 0.8) +
  coord_cartesian(ylim = c(0,1)) + 
  scale_y_continuous(breaks = seq(0,1, 0.1)) + 
  labs(
       #title = "Seasonal strength with respect to detrended series, by state, 2000:10-2020:2",
       title = NULL,
       y = "Seasonal strength with respect to detrended series")
  









```


## - Data for regression

```{r}
## combining data
df_reg_seaStr <- 
# left_join(
  df_seaStr %>% 
    filter(.model %in% c("SSDI", "SSI", "conc", "unemply", "dlunemply", "dunemply", "UIIC",
                         
                         "emplyMon_tot", "emplyMon_construction", "emplyMon_leisure",
                         "emplyMon_mining", "emplyMon_trade", "emplyMon_gov",
                         "emplyMon_high5", "emplyMon_modest4", "employment_modest2",
                         
                         "dlemplyMon_tot",    "dlemplyMon_construction", "dlemplyMon_leisure",
                         "dlemplyMon_mining", "dlemplyMon_trade",        "dlemplyMon_gov",
                         "dlemplyMon_high5",  "dlemplyMon_modest4",      "dlemployment_modest2"
                         )) %>% 
    select(-var_SR, -var_R) %>% 
    gather(Var, value, -State,-.model) %>% 
    unite(col = "Var", Var, .model, sep = ".") %>% 
    spread(Var, value) %>% 
  
  # df_seaStr %>% 
  #   filter(.model %in% c("unemply", "dlunemply", "dunemply")) %>% 
  #   select(-var_SR, -var_R) %>% 
  #   gather(Var, value, -State,-.model) %>% 
  #   unite(col = "Var", Var, .model, sep = ".") %>% 
  #   spread(Var, value),
  # by = "State"
  # %>% 
  left_join(df_temp_yrAvg, by = "State") %>% 
  left_join(df_emplyInd_share, by = "State")

df_reg_seaStr1 <- 
  df_reg_seaStr %>% filter(State %in% c(state.abb, "DC") )

names(df_reg_seaStr)
df_reg_seaStr$State %>% unique

```



## - Exploratory regressions, all states

```{r}




## Plotting the correlation
# DI
df_reg_seaStr1 %>% 
  filter(State %in% state.abb) %>% 
  ggplot(aes(x = seaStr_gg.dlunemply, y = seaStr_gg.SSDI)) + 
  geom_point()

df_reg_seaStr1 %>% 
  filter(State %in% state.abb) %>% 
  filter(!State %in% "AK") %>% 
  ggplot(aes(x = seaStr_gg.emplyMon_high5, y = seaStr_gg.SSDI)) + 
  geom_point()

df_reg_seaStr1 %>% 
  filter(State %in% state.abb) %>% 
  ggplot(aes(x = tempF, y = seaStr_gg.SSI)) + 
  geom_point()


# UI
df_reg_seaStr1 %>% 
  filter(State %in% state.abb) %>% 
  ggplot(aes(
             #x = seaStr_gg.emplyMon_tot, 
             x = seaStr_gg.unemply, 
             y = seaStr_gg.UIIC)) + 
  geom_point()
# df_reg_seaStr1 %>% 
#   filter(State %in% state.abb) %>% 
#   select(State, seaStr_gg.emplyMon_tot) %>% 
#   arrange(seaStr_gg.emplyMon_tot %>% desc)


df_reg_seaStr1 %>% 
  filter(State %in% state.abb) %>% 
  ggplot(aes(x = tempF, y = seaStr_gg.UIIC)) + 
  geom_point()


# employment and temperature
df_reg_seaStr1 %>% 
  filter(State %in% state.abb) %>% 
  filter(!State %in% "AK") %>% 
  ggplot(aes(x = seaStr_gg.emplyMon_construction, y = tempF)) + 
  geom_point()

df_reg_seaStr1 %>% 
  filter(State %in% state.abb) %>% 
  filter(!State %in% "AK") %>% 
  ggplot(aes(x = seaStr_gg.emplyMon_modest4, y = tempF)) + 
  geom_point()


# df_reg_seaStr1 %>% 
#   select(State,seaStr_gg.emplyMon_tot) %>% 
#   arrange(seaStr_gg.emplyMon_tot %>% desc)
# 
# df_reg_seaStr1 %>% 
#   select(State,seaStr_gg.unemply) %>% 
#   arrange(seaStr_gg.unemply %>% desc)


## Regressions unemployment and temperature (no ind structure)
# gg strength

# UI initial claim as reference
df_reg_seaStr1 %>% #(preferred model)
  filter(!State %in% c("AK")) %>% # "ND"
  lm(seaStr_gg.UIIC ~ seaStr_gg.unemply + tempF, data = .) %>% 
  summary()


df_reg_seaStr1 %>% 
  #filter(!State %in% c("AK")) %>% # "ND"
  lm(seaStr_gg.UIIC ~ seaStr_gg.emplyMon_tot + tempF, data = .) %>% 
  summary()


df_reg_seaStr1 %>% 
  filter(!State %in% c("AK")) %>% # "ND"
  lm(seaStr_var.UIIC ~ seaStr_var.unemply + tempF, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  filter(!State %in% c("AK")) %>% # "ND"
  lm(seaStr_var.UIIC ~ seaStr_var.emplyMon_tot + tempF, data = .) %>% 
  summary()

# UIIC
#   - employment is significant and greater than 1
#   - temperature is also significant and is negative
#   - results robust to using level or growth of unemployment
#   - robust to including AK, except for gg.emplyMon_tot


# Three types of DI applications

df_reg_seaStr1 %>% 
  filter(!State %in% c("AK")) %>%  #"CA"
  lm(seaStr_gg.SSDI ~ seaStr_gg.unemply + tempF, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  filter(!State %in% c("AK")) %>%  #"CA"
  lm(seaStr_gg.SSI ~ seaStr_gg.unemply + tempF, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  filter(!State %in% c("AK")) %>%  #"CA"
  lm(seaStr_gg.conc ~ seaStr_gg.unemply + tempF, data = .) %>% 
  summary()


# DI:
#   - unemployment is not significant, (level, difference, growth)
#   - tempF is significant only for concurrent, the estimate is very low and positive


# Var strength
df_reg_seaStr1 %>% 
    filter(!State %in% c("AK")) %>%  #"CA"
  lm(seaStr_var.SSDI ~ seaStr_var.unemply + tempF, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
    filter(!State %in% c("AK")) %>%  #"CA"
  lm(seaStr_var.SSI ~ seaStr_var.unemply + tempF, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
    filter(!State %in% c("AK")) %>%  #"CA"
  lm(seaStr_var.conc ~ seaStr_var.unemply + tempF, data = .) %>% 
  summary()


# DI: 
#  - unemployment is not significant 
#  - Temperature is significant and positive
# UIIC:
#  - unemployment is not significant
#  - Temerature is significant but negative

#  - results robust to using level or growth of unemployment



## Regressions w/ industry-specific employment and temperature
df_reg_seaStr1 %>% 
  filter(!State %in% c("DE", "HI", "AK")) %>% 
  lm(seaStr_gg.conc ~ tempF + 
                     seaStr_gg.emplyMon_construction +
                     #seaStr_gg.emplyMon_construction:emplyShare_construction +
                     emplyShare_construction +
                     seaStr_gg.emplyMon_modest4 +
                     #seaStr_gg.emplyMon_modest4:emplyShare_modestSea4 +
                     emplyShare_modestSea4,
                     
                     # seaStr_gg.emplyMon_construction*emplyShare_construction + 
                     # seaStr_gg.emplyMon_modest4*emplyShare_modestSea4,
                      # emplyShare_modestSea4,
                      # seaStr_gg.emplyMon_construction +  
                      # seaStr_gg.emplyMon_construction:emplyShare_construction+
                      # seaStr_gg.emplyMon_leisure + 
                      # seaStr_gg.emplyMon_mining,
     data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  filter(!State %in% c("DE", "HI", "AK")) %>% 
  lm(seaStr_var.conc ~ tempF + 
                     seaStr_var.emplyMon_construction+
                     seaStr_var.emplyMon_construction:emplyShare_construction+
                     seaStr_var.emplyMon_modest4 + 
                     seaStr_var.emplyMon_modest4:emplyShare_modestSea4,
                     
                      # emplyShare_modestSea4,
                      # seaStr_gg.emplyMon_construction +  
                      # seaStr_gg.emplyMon_construction:emplyShare_construction+
                      # seaStr_gg.emplyMon_leisure + 
                      # seaStr_gg.emplyMon_mining,
     data = .) %>% 
  summary()




## regressions w/o industrial structure
# gg strength
df_reg_seaStr1 %>% 
  lm(seaStr_gg.SSDI ~ seaStr_gg.unemply + tempF + emplyShare_construction + emplyShare_modestSea4 + emplyShare_farm, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_gg.SSI  ~ seaStr_gg.dunemply + tempF + emplyShare_construction + emplyShare_modestSea4 + emplyShare_farm, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_gg.conc ~ seaStr_gg.unemply + tempF + emplyShare_construction + emplyShare_modestSea4 + emplyShare_farm, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_gg.UIIC ~ seaStr_gg.unemply + tempF, data = .) %>% 
  summary()

#DI
#  - the three employment share variables have mixed significance.
#  - generally the shares of construction and farm are negative, and modestSea4 is possitive
# UIIC
#  - unemployment and temperature are still significant. 
#  - shares have similar results as DI


# Var strength
df_reg_seaStr1 %>% 
  lm(seaStr_var.SSDI ~ seaStr_var.unemply + tempF + emplyShare_construction + emplyShare_modestSea4 + emplyShare_farm, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_var.SSI ~ seaStr_var.dunemply + tempF + emplyShare_construction + emplyShare_modestSea4 + emplyShare_farm, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_var.conc ~ seaStr_var.unemply + tempF + emplyShare_construction + emplyShare_modestSea4 + emplyShare_farm, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_var.UIIC ~ seaStr_var.unemply + tempF, data = .) %>% 
  summary()


```


## - Exploratory regressions, large states and regions
```{r}
# 
df_reg_seaStr %>% 
  filter(State %in% regionNames) %>% 
  ggplot(aes(x = seaStr_gg.unemply, y = seaStr_gg.SSDI)) + 
  geom_point()
  
df_reg_seaStr %>% 
  filter(State %in% regionNames) %>% 
  ggplot(aes(x = seaStr_gg.unemply, y = seaStr_gg.SSI)) + 
  geom_point()

df_reg_seaStr %>% 
  filter(State %in% regionNames) %>% 
  ggplot(aes(x = seaStr_gg.unemply, y = seaStr_gg.conc)) + 
  geom_point()

df_reg_seaStr %>% 
  filter(State %in% regionNames) %>% 
  ggplot(aes(x = seaStr_gg.unemply, y = seaStr_gg.UIIC)) + 
  geom_point()

df_reg_seaStr %>% 
  filter(State %in% regionNames) %>% 
  ggplot(aes(x = seaStr_gg.emplyMon_high5, y = seaStr_gg.SSDI)) + 
  geom_point()
# SSDI is more correlated with highly seasonal employment



df_reg_seaStr %>% 
  filter(State %in% regionNames) %>% 
  arrange( seaStr_gg.SSDI) %>% 
  select("State", contains("_var."))

df_reg_seaStr %>% 
  filter(State %in% regionNames) %>% 
  arrange(seaStr_gg.SSDI) %>% 
  select("State", contains("_gg."))


```

## - **paper**: Regression 
```{r}

## Regressions unemployment and temperature (no ind structure)
# gg strength
# x <- 
# df_reg_seaStr1 %>% 
#   select(State, seaStr_gg.UIIC,  seaStr_gg.unemply, tempF, seaStr_gg.SSDI)

# UI initial claim as reference
reg_gg.UIIC1 <- 
  df_reg_seaStr1 %>% #(preferred model)
  filter(!State %in% c("AK", "HI", "DC")) %>% # "ND"
  lm(seaStr_gg.UIIC ~ seaStr_gg.unemply, data = .) 
reg_gg.UIIC1 %>% summary()

reg_gg.UIIC2 <- 
  df_reg_seaStr1 %>% #(preferred model)
  filter(!State %in% c("AK", "HI", "DC")) %>% # "ND"
  lm(seaStr_gg.UIIC ~ seaStr_gg.unemply + tempF, data = .) 
reg_gg.UIIC2 %>% summary()


reg_gg.UIIC3 <- 
  df_reg_seaStr1 %>% #(preferred model)
  filter(!State %in% c("AK", "HI", "DC")) %>% # "ND"
  lm(seaStr_gg.UIIC ~ seaStr_gg.unemply + tempF_sd, data = .) 
reg_gg.UIIC3 %>% summary()

# UIIC
#   - employment is significant and greater than 1
#   - temperature is also significant and is negative
#   - results robust to using level or growth of unemployment
#   - robust to including AK, except for gg.emplyMon_tot


# Three types of DI applications, unemployment only
reg_gg.SSDI1 <-
  df_reg_seaStr1 %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>%  #"CA"
  lm(seaStr_gg.SSDI ~ seaStr_gg.unemply , data = .) 

reg_gg.SSI1 <- 
  df_reg_seaStr1 %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>%  #"CA"
  lm(seaStr_gg.SSI ~ seaStr_gg.unemply , data = .) 

reg_gg.conc1 <- 
  df_reg_seaStr1 %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>%  #"CA"
  lm(seaStr_gg.conc ~ seaStr_gg.unemply, data = .) 

reg_gg.SSDI1 %>% summary()
reg_gg.SSI1 %>% summary()
reg_gg.conc1 %>% summary()

# Three types of DI applications, unemployment + temperature
reg_gg.SSDI2 <-
  df_reg_seaStr1 %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>%  #"CA"
  lm(seaStr_gg.SSDI ~ seaStr_gg.unemply + tempF, data = .) 

reg_gg.SSI2 <- 
  df_reg_seaStr1 %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>%  #"CA"
  lm(seaStr_gg.SSI ~ seaStr_gg.unemply + tempF, data = .) 

reg_gg.conc2 <- 
  df_reg_seaStr1 %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>%  #"CA"
  lm(seaStr_gg.conc ~ seaStr_gg.unemply + tempF, data = .) 


reg_gg.SSDI2 %>% summary()
reg_gg.SSI2  %>% summary()
reg_gg.conc2 %>% summary()

# DI:
#   - unemployment is not significant, (level, difference, growth)
#   - tempF is significant only for concurrent, the estimate is very low and positive


reg_gg.SSDI3 <-
  df_reg_seaStr1 %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>%  #"CA"
  lm(seaStr_gg1.SSDI ~ seaStr_gg.unemply + tempF_sd, data = .) 

reg_gg.SSI3 <- 
  df_reg_seaStr1 %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>%  #"CA"
  lm(seaStr_gg1.SSI ~ seaStr_gg.unemply + tempF_sd, data = .) 

reg_gg.conc3 <- 
  df_reg_seaStr1 %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>%  #"CA"
  lm(seaStr_gg1.conc ~ seaStr_gg.unemply + tempF_sd, data = .) 


reg_gg.SSDI3 %>% summary()
reg_gg.SSI3  %>% summary()
reg_gg.conc3 %>% summary()


## checking collinearity
df_reg_seaStr1 %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>%  #"CA"
  lm(seaStr_gg.unemply ~ tempF_sd, data = .) %>% 
  summary %>% 
  .$r.squared %>% 
  (function(x) 1/(1-x))(.)

df_reg_seaStr1 %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>%  #"CA"
  lm(tempF_sd ~ seaStr_gg.unemply, data = .) %>% 
  summary %>% 
  .$r.squared %>% 
  (function(x) 1/(1-x))(.)

# VIF is 1.172, indicating not much collinearity here


# Robust se

vcov.gg.UIIC1 <- sqrt(diag(vcovHC(reg_gg.UIIC1, method = "HC3")))
vcov.gg.UIIC2 <- sqrt(diag(vcovHC(reg_gg.UIIC2, method = "HC3")))
vcov.gg.UIIC3 <- sqrt(diag(vcovHC(reg_gg.UIIC3, method = "HC3")))

vcov.gg.SSDI1 <- sqrt(diag(vcovHC(reg_gg.SSDI1, method = "HC3")))
vcov.gg.SSDI2 <- sqrt(diag(vcovHC(reg_gg.SSDI2, method = "HC3")))
vcov.gg.SSDI3 <- sqrt(diag(vcovHC(reg_gg.SSDI3, method = "HC3")))

vcov.gg.SSI1 <- sqrt(diag(vcovHC(reg_gg.SSI1, method = "HC3")))
vcov.gg.SSI2 <- sqrt(diag(vcovHC(reg_gg.SSI2, method = "HC3")))
vcov.gg.SSI3 <- sqrt(diag(vcovHC(reg_gg.SSI3, method = "HC3")))

vcov.gg.conc1 <- sqrt(diag(vcovHC(reg_gg.conc1, method = "HC3")))
vcov.gg.conc2 <- sqrt(diag(vcovHC(reg_gg.conc2, method = "HC3")))
vcov.gg.conc3 <- sqrt(diag(vcovHC(reg_gg.conc3, method = "HC3")))



seaStr.gg_depvarNames <- c("UI initial", "SSID", "SSI", "Concurrent") 
seaStr.gg_covarNames  <- c("Sea. Strength of unemployment",  "Anuual average temp.") 
seaStr.gg_covarNames2  <- c("Sea. Strength of unemployment", "Std Dev. of monthly temp.")  
seaStr.gg_title <- "Regression results: seasonal amplitude"  

# unemployment only
stargazer(reg_gg.UIIC1, reg_gg.SSDI1, reg_gg.SSI1, reg_gg.conc1,  align = TRUE, type = "text",
          title = seaStr.gg_title,
          dep.var.labels= seaStr.gg_depvarNames,
          covariate.labels= seaStr.gg_covarNames[1],
          
          se = list(vcov.gg.UIIC1,
                    vcov.gg.SSDI1,
                    vcov.gg.SSI1,
                    vcov.gg.conc1)
          )

A# unemployment and annual avg temperature
stargazer(reg_gg.UIIC2, reg_gg.SSDI2, reg_gg.SSI2, reg_gg.conc2,  align = TRUE, type = "text",
          title = seaStr.gg_title,
          dep.var.labels= seaStr.gg_depvarNames,
          covariate.labels= seaStr.gg_covarNames,
          
          se = list(vcov.gg.UIIC2,
                    vcov.gg.SSDI2,
                    vcov.gg.SSI2,
                    vcov.gg.conc2)
          
          )

# unemployment and sd of monthly temperature
stargazer(reg_gg.UIIC3, reg_gg.SSDI3, reg_gg.SSI3, reg_gg.conc3,  align = TRUE, type = "text",
          title = seaStr.gg_title,
          dep.var.labels= seaStr.gg_depvarNames,
          covariate.labels= seaStr.gg_covarNames2,
          
          se = list(vcov.gg.UIIC3,
                    vcov.gg.SSDI3,
                    vcov.gg.SSI3,
                    vcov.gg.conc3)
          )



stargazer(reg_gg.UIIC1, reg_gg.SSDI1, reg_gg.SSI1, reg_gg.conc1,
          reg_gg.UIIC2, reg_gg.SSDI2, reg_gg.SSI2, reg_gg.conc2,  
          align = TRUE, type = "text",
          title = seaStr.gg_title,
          dep.var.labels= c(seaStr.gg_depvarNames, seaStr.gg_depvarNames),
          covariate.labels= seaStr.gg_covarNames,
          #column.labels = c("a", "b"),
          #column.separate = c(4, 4),
          
           se = list(vcov.gg.UIIC1,
                    vcov.gg.SSDI1,
                    vcov.gg.SSI1,
                    vcov.gg.conc1,
                    
                    vcov.gg.UIIC2,
                    vcov.gg.SSDI2,
                    vcov.gg.SSI2,
                    vcov.gg.conc2)
          )


# stargazer(reg_gg.UIIC, reg_gg.SSDI, reg_gg.SSI, reg_gg_conc,  align = TRUE,
#           title = seaStr.gg_title,
#           dep.var.labels= seaStr.gg_depvarNames,
#           covariate.labels= seaStr.gg_covarNames
#           )


```

# Regression with all months, data

## - Constructing variables
```{r}

df_reg_allmon <- 
    ls_ets$df_comp_ets %>% 
    filter(.model %in% c("SSDI", "SSI", "conc",  "UIIC",
                         
                         # unemployment: monthly level and % change
                         "unemply", "dlunemply",
                         
                         # employment: monthly level
                         "emplyMon_tot", "emplyMon_construction", "emplyMon_leisure",
                         "emplyMon_mining", "emplyMon_trade", "emplyMon_gov",
                         "emplyMon_high5",  "emplyMon_modest4", "employment_modest2",
                         
                         # employment: monthly % change
                         "dlemplyMon_tot",    "dlemplyMon_construction", "dlemplyMon_leisure",
                         "dlemplyMon_mining", "dlemplyMon_trade",        "dlemplyMon_gov",
                         "dlemplyMon_high5",  "dlemplyMon_modest4",      "dlemployment_modest2"
                         )) %>% 
    as_tibble %>% 
    filter(!is.na(season)) %>% 
    mutate(month = month(date_yearmon)) %>% 
    group_by(State, .model, month) %>% 
    # average seasonal factors across years
    summarise(season = mean(season, na.rm = TRUE), .groups = "drop_last") %>% 
    spread(.model, season) 


df_reg_allmon %<>% 
  left_join(df_temp_monAvg %>% rename(month = Month), by = c("State", "month") ) %>% 
  left_join(df_emplyInd_share,   by = "State") %>% 
  ungroup


# df_reg_allmon %>% names

## Create 1, 2 and 3-month lags for all variables
# append Nov and Dec values, with Nov as -1 and Dec as 0

df_reg_allmon %<>% 
  gather(Var, L0, -State, -month) 

df_reg_allmon <- 
 bind_rows(
   df_reg_allmon,

   df_reg_allmon %>% 
     filter(month %in% c(10, 11, 12)) %>% 
     mutate(month = month - 12)
) %>% 
  arrange(Var, State, month)


df_reg_allmon %<>% 
  mutate(L1 = dplyr::lag(L0, 1), 
         L2 = dplyr::lag(L0, 2),
         L3 = dplyr::lag(L0, 3)) %>% 
  gather(nLag, valLag, -State, -month, -Var) %>% 
  unite("Var", nLag, Var, sep = ".") %>% 
  mutate(Var = str_remove(Var, "L0.")) %>% 
  filter(month %in% 1:12) %>% 
  spread(Var, valLag) %>% 
  relocate(State, month, SSDI, SSI, conc, UIIC) %>% 
   mutate(
     seaQ_DIa = case_when(
       month %in% c(3, 4, 5)   ~ "Q1",    # Spring
       month %in% c(6, 7, 8)   ~ "Q2",  # Summer 1: June, July
       month %in% c(9, 10, 11) ~ "Q3",    # Fall
       month %in% c(12, 1, 2)  ~ "Q4"     # Winter
     ),
     
     seaQ_DIb = case_when(
       month %in% c(3, 4, 5)   ~ "Q1",    # Spring
       month %in% c(6, 7)      ~ "Q2.1",  # Summer 1: June, July
       month %in% c(8)         ~ "Q2.2",  # Summer 2:Aug
       month %in% c(9, 10, 11) ~ "Q3",    # Fall
       month %in% c(12, 1, 2)  ~ "Q4"     # Winter
     ),
     
  
     month = factor(month),
     State = factor(State)
          )

# Keep states only
df_reg_allmon_states <-  
  df_reg_allmon %>% 
  filter(State %in% state.abb)


# df_reg_allmon %>% names


# create within-month variables 

df_reg_allmon_within <- 
  df_reg_allmon %>% 
  group_by(month) %>% 
  mutate(across(-c(State, seaQ_DIa, seaQ_DIb), ~ .x - mean(.x, na.rm =TRUE)))

df_reg_allmon_within_states <-  
  df_reg_allmon_within %>% 
  filter(State %in% state.abb)




df_reg_allmon_states %<>% 
  relocate(month, State)

df_reg_allmon_within_states %<>% 
  relocate(month, State)




```



# Regression: seasonal pettern with all months

LHS vars: for SSDI, SDI, and conc, and UIIC
 - seasonal factors for all months and states as a single variable 

RHS var
- unemployment and employment, level and % change
   - seasonal factors for all months and states, with lags
- Temperature:
   - avg temp in all months and all states
- Industrial structure by state (same for all month)
    - share of construction
    - share of highest 5
    - share of modest 4
    - share of farm
- Interaction with each month







## - Exploratory regression: interation with each month

```{r}

### UI claims

df_reg_allmon_states %>% 
   filter(!State %in% c("AK", "MI" )) %>% 
   #lm(UIIC ~ dlunemply:month + L1.dlunemply:month + L1.tempF:month, data = .) %>% 
   lm(UIIC ~ dlunemply:month + L1.dlunemply:month + L1.tempF:month, data = .) %>% 
   summary()


# 1mon lag
df_reg_allmon_states %>% 
   filter(!State %in% c("AK", "MI")) %>% 
   #lm(UIIC ~ dlunemply:month + L1.dlunemply:month + L1.tempF:month, data = .) %>% 
   lm(UIIC ~ L1.unemply:month + tempF:month, data = .) %>% 
   summary()

# no lag + 1mon lag
df_reg_allmon_states %>% 
   filter(!State %in% c("AK", "MI")) %>% 
   lm(UIIC ~ unemply:month + L1.unemply:month + tempF:month, data = .) %>% 
   summary()

# No lag
df_reg_allmon_states %>% 
   filter(!State %in% c("AK")) %>% 
   lm(UIIC ~ unemply:month + tempF:month, data = .) %>% 
   summary()


# When using unemployment levels:
#  No lag: (makes the most sense so far)
#    - Unemployment: Nov~Apirl are sig
#    - Temp: Summer(+) and winter(-) are sig, signs as expected, robut to using L0, L1
#    - not sensitive to "AK", "MI"
#  0-1 lag:
#    - unemployment L0: Sig in winter and 4, 7, 9
#    - unemployment L1: Mostly have negative signs. sig in winder and 4, 7, 9 
#    - Temp: Summer(+) and winter(-) are sig, signs as expected, robut to using L0, L1

# When using unemployment monthly changes
#  Unemployment, winters and summers(less) are sig
#  Temp: Summer(-) and winter(+), signs not expected.

# Take away:
#  - Employment has the biggest impact in winter and early spring
#  - Temperature has the biggest impact on summer and winter



### DI applications ----

# Variations in model specs
#  - level unemployment (preferred), monthly change unemployment
#  - Lags: (L1 + L2), L1, L2
#  - Interaction:
#     - months
#     - Seasons
#     - Seasons, separate dummy for Aug 
#  - Temprature: L1, L2
#     - consider 2/3-month moving average temperature


# SSDI
#  interaction with each month
df_reg_allmon_states %>% 
   filter(!State %in% c("AK")) %>% 
   mutate(seaQ_DI = seaQ_DIa) %>% 
   # lm(SSDI ~ L1.dlunemply:month + L2.dlunemply:month + tempF:month, data = .) %>% 
   # lm(SSDI ~ L1.unemply:month + tempF:month, data = .) %>% 
   #lm(SSDI ~ L2.unemply:month,  data = .) %>% 
   
   #lm(SSDI ~ L1.unemply:month + tempF:month, data = .) %>% 
   lm(SSDI ~ L2.unemply:month + tempF:month, data = .) %>% 
   #lm(SSDI ~ L1.unemply:month + L2.unemply:month + tempF:month, data = .) %>% 
   summary()

## When only including 1-mon lag or 2-mon lag
#   - Unemployment is sig in mon 2, 3, 4, 5 (spring), but not in Aug
#   - Temperature: sig in mon 6, 7, 8 (summer),9, and in 12,1 (winter)
#   - Robustness 
#      - robust to using 1mon lag and 2mon lag of employment
#      - robust to using 1 month lag or current month temperature. 
#      - robust to including "AK" or not.

## When including 1-mon and 2-mon lags
#    - Employment coeffs are mostly not sig
#    - Temperature coeffs are still sig in summer and winter. 
#    - F-test, are 1mon and 2mon lags jointly sig? 
#      - 1mon and 2mon lags are jointly sig for month 2~5. consistent with single lag 
#        regression.
#       https://bookdown.org/ccolonescu/RPoE4/further-inference-in-multiple-regression.html

#  thoughts: employment condition is trigger of DI (SSDI/SSI) applications. 







# SSDI interaction with seasons
df_reg_allmon_states %>% 
   filter(!State %in% c("AK")) %>% 
   mutate(seaQ_DI = seaQ_DIb) %>% 
   # lm(SSDI ~ L1.dlunemply:month + L2.dlunemply:month + tempF:month, data = .) %>% 
   #lm(SSDI ~ L1.unemply:seaQ_DI + tempF:seaQ_DI, data = .) %>% 
   #lm(SSDI ~ L1.unemply:seaQ_DI + L2.unemply:seaQ_DI + tempF:seaQ_DI, data = .) %>% 
  
   #lm(SSDI ~ L1.unemply:seaQ_DI, data = .) %>% 
   lm(SSDI ~ L1.unemply:seaQ_DI + tempF:seaQ_DI, data = .) %>% 
   summary()


# Notes
#  - including 1m and 2m lags can give confusing results, the impact of temparature 
#    in summer and winter are signficiant.




# SSI
df_reg_allmon_states %>% 
   filter(!State %in% c("AK")) %>% 
   lm(SSI ~ L1.unemply:month + tempF:month, data = .) %>% 
   #lm(SSI ~ L2.unemply:month + tempF:month, data = .) %>% 
   #lm(SSI ~ L1.unemply:month + L2.unemply:month + L1.tempF:month, data = .) %>% 
   summary()



df_reg_allmon_states %>% 
   filter(!State %in% c("AK")) %>% 
   lm(conc ~ L1.unemply:month + tempF:month, data = .) %>% 
   #lm(conc ~ L2.unemply:month + tempF:month, data = .) %>% 
   #lm(conc ~ L1.unemply:month + L2.unemply:month + L1.tempF:month, data = .) %>% 
   summary()





mod1.UIIC <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK")) %>% 
  lm(UIIC ~ unemply:month + tempF:month, data = .)
mod1.UIIC %>% summary

mod1.SSDI <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK")) %>% 
  lm(SSDI ~ L1.unemply:month + tempF:month, data = .)

mod1.SSI <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK")) %>% 
  lm(SSI ~ L1.unemply:month + tempF:month, data = .)

mod1.conc <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK")) %>% 
  lm(conc ~ L1.unemply:month + tempF:month, data = .)


summary(mod1.UIIC)
summary(mod1.SSDI)
summary(mod1.SSI)
summary(mod1.conc)






## F-test for joint sig of 1mon and 2mon lags

H0 <- function(mon){
  c1 <- paste0("L1.unemply:month", mon, "=0")
  c2 <- paste0("month", mon, ":L2.unemply=0")
  c(c1, c2)
}

H0_UIIC <- function(mon){
  c1 <- paste0("unemply:month", mon, "=0")
  c2 <- paste0("month", mon, ":L1.unemply=0")
  c(c1, c2)
}


mod.UIIC <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK")) %>% 
  lm(UIIC ~ unemply:month + L1.unemply:month + tempF:month, data = .)
mod.UIIC %>% summary

mod.SSDI <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK")) %>% 
  lm(SSDI ~ L1.unemply:month + L2.unemply:month + tempF:month, data = .)

mod.SSI <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK")) %>% 
  lm(SSI ~ L1.unemply:month + L2.unemply:month + tempF:month, data = .)

mod.conc <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK")) %>% 
  lm(conc ~ L1.unemply:month + L2.unemply:month + tempF:month, data = .)


summary(mod.UIIC)
summary(mod.SSDI)
summary(mod.SSI)
summary(mod.conc)
#tidy(mod.SSDI)


Ftest_UIIC <- map(1:12, function(x) linearHypothesis(mod.UIIC, H0_UIIC(x)))
map_dfr(Ftest_UIIC, ~.x[2,])
# consistent with model with 0 and 1 lages


Ftest_SSDI <- map(1:12, function(x) linearHypothesis(mod.SSDI, H0(x)))
map_dfr(Ftest_SSDI, ~.x[2,])


Ftest_SSI <- map(1:12, function(x) linearHypothesis(mod.SSI, H0(x)))
map_dfr(Ftest_SSI, ~.x[2,])


Ftest_conc <- map(1:12, function(x) linearHypothesis(mod.conc, H0(x)))
map_dfr(Ftest_conc, ~.x[2,])


## Notes (1&2mon lags)
# For DI applications
#  - Spring and summer months are mostly sig. 
#    - SSDI summer months:sig at 10%
#    - All other: sig at 5%
#  - Winter is not sig 

#  - Temperature(or vars it proxied) are still sig. 
#    - The impact is neg in spring(-), this offset employment
#    - The impact is large in summer (+), reinforce employoment 
#    - The impact is neg in winter(-), when employment not sig

# For UI claims
#  - Winter and Summper peaks are associated with both unemployment and temperature
#  - The Aug/Sep trough is hard to explain: unemployment is neg, temperature is pos


## Overall conclusion
#   - spring and summer peaks in DI applications are associated with unemployment
#   - Winter trough (nov~jan) is more likely to be associatd with temperature


## Next steps:
#   - Plot the results
#   - The relative importance of employment and temperature 
#   - Better standard errors? Clustered? 


```


## - **paper**: Regressions

```{r}


### UI claims

# No lag
reg_allmon_UIIC.L0 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(I(UIIC-1) ~ I(unemply-1):month + tempF:month, data = .)
reg_allmon_UIIC.L0 %>% summary

# 1mon lag
reg_allmon_UIIC.L1 <-
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(I(UIIC - 1) ~ I(L1.unemply - 1) :month + tempF:month, data = .) 

reg_allmon_UIIC.L1 %>% summary 

# no lag + 1mon lag
reg_allmon_UIIC.L0L1 <-
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(I(UIIC-1) ~ I(unemply-1):month + I(L1.unemply-1):month + tempF:month, data = .)
reg_allmon_UIIC.L0L1 %>% summary





# When using unemployment levels:
#  No lag: (makes the most sense so far)
#    - Unemployment: Nov~Apirl are sig
#    - Temp: Summer(+) and winter(-) are sig, signs as expected, robut to using L0, L1
#    - not sensitive to "AK", "MI"
#  0-1 lag:
#    - unemployment L0: Sig in winter and 4, 7, 9
#    - unemployment L1: Mostly have negative signs. sig in winder and 4, 7, 9 
#    - Temp: Summer(+) and winter(-) are sig, signs as expected, robut to using L0, L1

# When using unemployment monthly changes
#  Unemployment, winters and summers(less) are sig
#  Temp: Summer(-) and winter(+), signs not expected.

# Take away:
#  - Employment has the biggest impact in winter and early spring
#  - Temperature has the biggest impact on summer and winter



### DI applications ----

# Variations in model specs
#  - level unemployment (preferred), monthly change unemployment
#  - Lags: (L1 + L2), L1, L2
#  - Interaction:
#     - months
#     - Seasons
#     - Seasons, separate dummy for Aug 
#  - Temprature: L1, L2
#     - consider 2/3-month moving average temperature


# SSDI
#  interaction with each month
reg_allmon_SSDI.L1 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSDI ~ L1.unemply:month + tempF:month, data = .) 
reg_allmon_SSDI.L1 %>% summary

reg_allmon_SSDI.L2 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  mutate(seaQ_DI = seaQ_DIa) %>% 
  lm(SSDI ~ L2.unemply:month + tempF:month, data = .) 

reg_allmon_SSDI.L1L2 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  mutate(seaQ_DI = seaQ_DIa) %>% 
  lm(SSDI ~  L1.unemply:month + L2.unemply:month + tempF:month, data = .) 




df_reg_allmon_states %>%
  filter(!State %in% c("AK", "HI", "DC")) %>%
  # filter(month == 3) %>%
  lm(I(SSDI-1) ~ I(L1.unemply-1):month + tempF:month + month, data = .) %>%
  summary


df_reg_allmon_states %>%
  filter(!State %in% c("AK", "HI", "DC")) %>%
  # filter(month == 3) %>%
  lm(I(SSDI-1) ~ I(L2.unemply-1):month + tempF:month, data = .) %>%
  summary

df_reg_allmon_states %>%
  filter(!State %in% c("AK", "HI", "DC")) %>%
  # filter(month == 3) %>%
  lm(I(SSDI-1) ~ I(L1.unemply-1):month + I(L2.unemply-1):month + tempF:month, data = .) %>%
  summary


## SSI
df_reg_allmon_states %>%
  filter(!State %in% c("AK", "HI", "DC")) %>%
  # filter(month == 3) %>%
  lm(I(SSI-1) ~ I(L1.unemply-1):month + tempF:month, data = .) %>%
  summary


df_reg_allmon_states %>%
  filter(!State %in% c("AK", "HI", "DC")) %>%
  # filter(month == 3) %>%
  lm(I(SSI-1) ~ I(L2.unemply-1):month + tempF:month, data = .) %>%
  summary

df_reg_allmon_states %>%
  filter(!State %in% c("AK", "HI", "DC")) %>%
  # filter(month == 3) %>%
  lm(I(SSI-1) ~ I(L1.unemply-1):month + I(L2.unemply-1):month + tempF:month, data = .) %>%
  summary


## Concurrent
df_reg_allmon_states %>%
  filter(!State %in% c("AK", "HI", "DC")) %>%
  # filter(month == 3) %>%
  lm(I(conc-1) ~ I(L1.unemply-1):month + tempF:month, data = .) %>%
  summary


df_reg_allmon_states %>%
  filter(!State %in% c("AK", "HI", "DC")) %>%
  # filter(month == 3) %>%
  lm(I(conc-1) ~ I(L2.unemply-1):month + tempF:month, data = .) %>%
  summary

df_reg_allmon_states %>%
  filter(!State %in% c("AK", "HI", "DC")) %>%
  # filter(month == 3) %>%
  lm(I(conc-1) ~ I(L1.unemply-1):month + I(L2.unemply-1):month + tempF:month, data = .) %>%
  summary



## When only including 1-mon lag or 2-mon lag
#   - Unemployment is sig in mon 2, 3, 4, 5 (spring), but not in Aug
#   - Temperature: sig in mon 6, 7, 8 (summer),9, and in 12,1 (winter)
#   - Robustness 
#      - robust to using 1mon lag and 2mon lag of employment
#      - robust to using 1 month lag or current month temperature. 
#      - robust to including "AK" or not.

## When including 1-mon and 2-mon lags
#    - Employment coeffs are mostly not sig
#    - Temperature coeffs are still sig in summer and winter. 
#    - F-test, are 1mon and 2mon lags jointly sig? 
#      - 1mon and 2mon lags are jointly sig for month 2~5. consistent with single lag 
#        regression.
#       https://bookdown.org/ccolonescu/RPoE4/further-inference-in-multiple-regression.html

#  thoughts: employment condition is trigger of DI (SSDI/SSI) applications. 







# SSI
# df_reg_allmon_states %>% 
#    filter(!State %in% c("AK")) %>% 
#    lm(SSI ~ L1.unemply:month + tempF:month, data = .) %>% 
#    #lm(SSI ~ L2.unemply:month + tempF:month, data = .) %>% 
#    #lm(SSI ~ L1.unemply:month + L2.unemply:month + L1.tempF:month, data = .) %>% 
#    summary()

reg_allmon_SSDI.L1 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  mutate(seaQ_DI = seaQ_DIa) %>% 
  lm(SSDI ~ L1.unemply:month + tempF:month, data = .) 
reg_allmon_SSDI.L1 %>% summary



df_reg_allmon_states %>% 
   filter(!State %in% c("AK")) %>% 
   lm(conc ~ L1.unemply:month + tempF:month, data = .) %>% 
   #lm(conc ~ L2.unemply:month + tempF:month, data = .) %>% 
   #lm(conc ~ L1.unemply:month + L2.unemply:month + L1.tempF:month, data = .) %>% 
   summary()


## F-test
mod.UIIC <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK")) %>% 
  lm(I(UIIC - 1) ~ I(unemply-1):month + I(L1.unemply-1):month + tempF:month, data = .)
mod.UIIC %>% summary

mod.SSDI <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK")) %>% 
  lm(I(SSDI - 1) ~ I(L1.unemply - 1):month + I(L2.unemply - 1):month + tempF:month, data = .)

mod.SSI <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK")) %>% 
  lm(I(SSI - 1) ~ I(L1.unemply - 1):month + I(L2.unemply - 1):month + tempF:month, data = .)

mod.conc <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK")) %>% 
  lm(I(conc - 1) ~ I(L1.unemply - 1):month + I(L2.unemply - 1):month + tempF:month, data = .)


summary(mod.UIIC)
summary(mod.SSDI)
summary(mod.SSI)
summary(mod.conc)



H0 <- function(mon){
  c1 <- paste0("I(L1.unemply - 1):month", mon, "=0")
  c2 <- paste0("month", mon, ":I(L2.unemply - 1)=0")
  c(c1, c2)
}

H0_UIIC <- function(mon){
  c1 <- paste0("I(unemply - 1):month", mon, "=0")
  c2 <- paste0("month", mon, ":I(L1.unemply - 1)=0")
  c(c1, c2)
}

Ftest_UIIC <- map(1:12, function(x) linearHypothesis(mod.UIIC, H0_UIIC(x)))
map_dfr(Ftest_UIIC, ~.x[2,])
# consistent with model with 0 and 1 lages


Ftest_SSDI <- map(1:12, function(x) linearHypothesis(mod.SSDI, H0(x)))
map_dfr(Ftest_SSDI, ~.x[2,])


Ftest_SSI <- map(1:12, function(x) linearHypothesis(mod.SSI, H0(x)))
map_dfr(Ftest_SSI, ~.x[2,])


Ftest_conc <- map(1:12, function(x) linearHypothesis(mod.conc, H0(x)))
map_dfr(Ftest_conc, ~.x[2,])




```



# Regression: within-month variation, all months

Use deviation 



## - exploratory: lm

```{r}


# Variations in model specs
#  - level unemployment (preferred), monthly change unemployment
#  - Lags: (L1 + L2), L1, L2
#  - Interaction:
#     - months
#     - Seasons
#     - Seasons, separate dummy for Aug 
#  - Temprature: L1, L2
#     - consider 2/3-month moving average temperature




### UI claims ------------------------------------------------------------------

# No lag
reg_allmon_UIIC.L0 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(UIIC ~ unemply - 1 , data = .)
reg_allmon_UIIC.L0 %>% summary

reg_allmon_UIIC.L0 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(UIIC ~ unemply + tempF:month - 1, data = .)
reg_allmon_UIIC.L0 %>% summary

reg_allmon_UIIC.L0 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(UIIC ~ unemply:month + tempF:month - 1, data = .)
reg_allmon_UIIC.L0 %>% summary


# 1mon lag
reg_allmon_UIIC.L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(UIIC ~ L1.unemply - 1, data = .)
reg_allmon_UIIC.L1 %>% summary

reg_allmon_UIIC.L1<- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(UIIC ~ L1.unemply + tempF:month -1, data = .)
reg_allmon_UIIC.L1 %>% summary

reg_allmon_UIIC.L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(UIIC ~ L1.unemply:month + tempF:month - 1, data = .)
reg_allmon_UIIC.L1 %>% summary



# no lag + 1mon lag
reg_allmon_UIIC.L0L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(UIIC ~ unemply + L1.unemply - 1, data = .)
reg_allmon_UIIC.L0L1 %>% summary

reg_allmon_UIIC.L0L1<- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(UIIC ~ unemply + L1.unemply + tempF:month - 1, data = .)
reg_allmon_UIIC.L0L1 %>% summary

reg_allmon_UIIC.L0L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(UIIC ~ unemply:month + L1.unemply:month + tempF:month - 1, data = .)
reg_allmon_UIIC.L0L1 %>% summary


# Take away:


### SSDI claims ------------------------------------------------------------------

# 0mon lag
reg_allmon_SSDI.L0 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSDI ~ unemply - 1 , data = .)
reg_allmon_SSDI.L0 %>% summary

reg_allmon_SSDI.L0 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSDI ~ unemply + tempF:month - 1, data = .)
reg_allmon_SSDI.L0 %>% summary

reg_allmon_SSDI.L0 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSDI ~ unemply:month + tempF:month - 1, data = .)
reg_allmon_SSDI.L0 %>% summary



# 1mon lag
reg_allmon_SSDI.L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSDI ~ L1.unemply - 1 , data = .)
reg_allmon_SSDI.L1 %>% summary

reg_allmon_SSDI.L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSDI ~ L1.unemply + tempF:month - 1, data = .)
reg_allmon_SSDI.L1 %>% summary

reg_allmon_SSDI.L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSDI ~ L1.unemply:month + tempF:month - 1, data = .)
reg_allmon_SSDI.L1 %>% summary


# 2mon lag
reg_allmon_SSDI.L2 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSDI ~ L2.unemply - 1, data = .)
reg_allmon_SSDI.L2 %>% summary

reg_allmon_SSDI.L2<- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSDI ~ L2.unemply + tempF:month -1, data = .)
reg_allmon_SSDI.L2 %>% summary

reg_allmon_SSDI.L2 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSDI ~ L2.unemply:month + tempF:month - 1, data = .)
reg_allmon_SSDI.L2 %>% summary



# no lag + 1mon lag
reg_allmon_SSDI.L0L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSDI ~ unemply + L1.unemply - 1, data = .)
reg_allmon_SSDI.L0L1 %>% summary

reg_allmon_SSDI.L0L1<- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSDI ~ unemply + L1.unemply + tempF:month - 1, data = .)
reg_allmon_SSDI.L0L1 %>% summary

reg_allmon_SSDI.L0L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSDI ~ unemply:month + L1.unemply:month + tempF:month - 1, data = .)
reg_allmon_SSDI.L0L1 %>% summary




### SSI claims ------------------------------------------------------------------

# 0mon lag
reg_allmon_SSI.L0 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSI ~ unemply - 1 , data = .)
reg_allmon_SSI.L0 %>% summary

reg_allmon_SSI.L0 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSI ~ unemply + tempF:month - 1, data = .)
reg_allmon_SSI.L0 %>% summary

reg_allmon_SSI.L0 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSI ~ unemply:month + tempF:month - 1, data = .)
reg_allmon_SSI.L0 %>% summary



# 1mon lag
reg_allmon_SSI.L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSI ~ L1.unemply - 1 , data = .)
reg_allmon_SSI.L1 %>% summary

reg_allmon_SSI.L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSI ~ L1.unemply + tempF:month - 1, data = .)
reg_allmon_SSI.L1 %>% summary

reg_allmon_SSI.L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSI ~ L1.unemply:month + tempF:month - 1, data = .)
reg_allmon_SSI.L1 %>% summary


# 2mon lag
reg_allmon_SSI.L2 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSI ~ L2.unemply - 1, data = .)
reg_allmon_SSI.L2 %>% summary

reg_allmon_SSI.L2<- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSI ~ L2.unemply + tempF:month -1, data = .)
reg_allmon_SSI.L2 %>% summary

reg_allmon_SSI.L2 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSI ~ L2.unemply:month + tempF:month - 1, data = .)
reg_allmon_SSI.L2 %>% summary



# no lag + 1mon lag
reg_allmon_SSI.L0L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSI ~ unemply + L1.unemply - 1, data = .)
reg_allmon_SSI.L0L1 %>% summary

reg_allmon_SSI.L0L1<- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSI ~ unemply + L1.unemply + tempF:month - 1, data = .)
reg_allmon_SSI.L0L1 %>% summary

reg_allmon_SSI.L0L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(SSI ~ unemply:month + L1.unemply:month + tempF:month - 1, data = .)
reg_allmon_SSI.L0L1 %>% summary



### Concurrent claims ------------------------------------------------------------------

# 0mon lag
reg_allmon_conc.L0 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(conc ~ unemply - 1 , data = .)
reg_allmon_conc.L0 %>% summary

reg_allmon_conc.L0 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(conc ~ unemply + tempF:month - 1, data = .)
reg_allmon_conc.L0 %>% summary

reg_allmon_conc.L0 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(conc ~ unemply:month + tempF:month - 1, data = .)
reg_allmon_conc.L0 %>% summary



# 1mon lag
reg_allmon_conc.L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(conc ~ L1.unemply - 1 , data = .)
reg_allmon_conc.L1 %>% summary

reg_allmon_conc.L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(conc ~ L1.unemply + tempF:month - 1, data = .)
reg_allmon_conc.L1 %>% summary

reg_allmon_conc.L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(conc ~ L1.unemply:month + tempF:month - 1, data = .)
reg_allmon_conc.L1 %>% summary


# 2mon lag
reg_allmon_conc.L2 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(conc ~ L2.unemply - 1, data = .)
reg_allmon_conc.L2 %>% summary

reg_allmon_conc.L2<- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(conc ~ L2.unemply + tempF:month -1, data = .)
reg_allmon_conc.L2 %>% summary

reg_allmon_conc.L2 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(conc ~ L2.unemply:month + tempF:month - 1, data = .)
reg_allmon_conc.L2 %>% summary



# no lag + 1mon lag
reg_allmon_conc.L0L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(conc ~ unemply + L1.unemply - 1, data = .)
reg_allmon_conc.L0L1 %>% summary

reg_allmon_conc.L0L1<- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(conc ~ unemply + L1.unemply + tempF:month - 1, data = .)
reg_allmon_conc.L0L1 %>% summary

reg_allmon_conc.L0L1 <- 
  df_reg_allmon_within_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  lm(conc ~ unemply:month + L1.unemply:month + tempF:month - 1, data = .)
reg_allmon_conc.L0L1 %>% summary













## F-test-----------------------------------------------------------------------
# mod.UIIC <- 
#   df_reg_allmon_states %>% 
#   filter(!State %in% c("AK")) %>% 
#   lm(I(UIIC - 1) ~ I(unemply-1):month + I(L1.unemply-1):month + tempF:month, data = .)
# mod.UIIC %>% summary
# 
# mod.SSDI <- 
#   df_reg_allmon_states %>% 
#   filter(!State %in% c("AK")) %>% 
#   lm(I(SSDI - 1) ~ I(L1.unemply - 1):month + I(L2.unemply - 1):month + tempF:month, data = .)
# 
# mod.SSI <- 
#   df_reg_allmon_states %>% 
#   filter(!State %in% c("AK")) %>% 
#   lm(I(SSI - 1) ~ I(L1.unemply - 1):month + I(L2.unemply - 1):month + tempF:month, data = .)
# 
# mod.conc <- 
#   df_reg_allmon_states %>% 
#   filter(!State %in% c("AK")) %>% 
#   lm(I(conc - 1) ~ I(L1.unemply - 1):month + I(L2.unemply - 1):month + tempF:month, data = .)
# 
# 
# summary(mod.UIIC)
# summary(mod.SSDI)
# summary(mod.SSI)
# summary(mod.conc)
# 
# 
# 
# H0 <- function(mon){
#   c1 <- paste0("I(L1.unemply - 1):month", mon, "=0")
#   c2 <- paste0("month", mon, ":I(L2.unemply - 1)=0")
#   c(c1, c2)
# }
# 
# H0_UIIC <- function(mon){
#   c1 <- paste0("I(unemply - 1):month", mon, "=0")
#   c2 <- paste0("month", mon, ":I(L1.unemply - 1)=0")
#   c(c1, c2)
# }
# 
# Ftest_UIIC <- map(1:12, function(x) linearHypothesis(mod.UIIC, H0_UIIC(x)))
# map_dfr(Ftest_UIIC, ~.x[2,])
# # consistent with model with 0 and 1 lages
# 
# 
# Ftest_SSDI <- map(1:12, function(x) linearHypothesis(mod.SSDI, H0(x)))
# map_dfr(Ftest_SSDI, ~.x[2,])
# 
# 
# Ftest_SSI <- map(1:12, function(x) linearHypothesis(mod.SSI, H0(x)))
# map_dfr(Ftest_SSI, ~.x[2,])
# 
# 
# Ftest_conc <- map(1:12, function(x) linearHypothesis(mod.conc, H0(x)))
# map_dfr(Ftest_conc, ~.x[2,])




```


## - exploratory: plm

```{r}

df_reg_allmon_within_states %<>% 
  relocate(month, State)

df_reg_allmon_states %<>% 
  relocate(month, State)


# UIIC -------------------------------------------------------------------------

# no lag
plm_allmon_UIIC.L0 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(UIIC ~ unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)
plm_allmon_UIIC.L0 %>% summary
plm_allmon_UIIC.L0 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
# plm_allmon_UIIC.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_UIIC.L0 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(UIIC ~ unemply + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_UIIC.L0 %>% summary
plm_allmon_UIIC.L0 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_UIIC.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_UIIC.L0 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(UIIC ~ unemply:month + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_UIIC.L0 %>% summary
plm_allmon_UIIC.L0 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_UIIC.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))



# 1mon lag
plm_allmon_UIIC.L1 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(UIIC ~ L1.unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)
plm_allmon_UIIC.L1 %>% summary
plm_allmon_UIIC.L1 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_UIIC.L1 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_UIIC.L1 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(UIIC ~ L1.unemply + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_UIIC.L1 %>% summary
plm_allmon_UIIC.L1 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_UIIC.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_UIIC.L1 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(UIIC ~ L1.unemply:month + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_UIIC.L1 %>% summary
plm_allmon_UIIC.L1 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_UIIC.L1 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))






# SSDI -------------------------------------------------------------------------

# no lag
plm_allmon_SSDI.L0 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSDI ~ unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)
plm_allmon_SSDI.L0 %>% summary
plm_allmon_SSDI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
# plm_allmon_SSDI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_SSDI.L0 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSDI ~ unemply + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_SSDI.L0 %>% summary
plm_allmon_SSDI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSDI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_SSDI.L0 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSDI ~ unemply:month + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_SSDI.L0 %>% summary
plm_allmon_SSDI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSDI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))



# 1mon lag
plm_allmon_SSDI.L1 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSDI ~ L1.unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)
plm_allmon_SSDI.L1 %>% summary
plm_allmon_SSDI.L1 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSDI.L1 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_SSDI.L1 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSDI ~ L1.unemply + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_SSDI.L1 %>% summary
plm_allmon_SSDI.L1 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSDI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_SSDI.L1 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSDI ~ L1.unemply:month + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_SSDI.L1 %>% summary
plm_allmon_SSDI.L1 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSDI.L1 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


# 2mon lag
plm_allmon_SSDI.L2 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSDI ~ L2.unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)
plm_allmon_SSDI.L2 %>% summary
plm_allmon_SSDI.L2 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSDI.L1 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_SSDI.L2 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSDI ~ L2.unemply + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_SSDI.L2 %>% summary
plm_allmon_SSDI.L2 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSDI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_SSDI.L2 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSDI ~ L2.unemply:month + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_SSDI.L2 %>% summary
plm_allmon_SSDI.L2 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSDI.L1 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))



# SSI -------------------------------------------------------------------------
# no lag
plm_allmon_SSI.L0 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSI ~ unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)
plm_allmon_SSI.L0 %>% summary
plm_allmon_SSI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
# plm_allmon_SSI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_SSI.L0 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSI ~ unemply + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_SSI.L0 %>% summary
plm_allmon_SSI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_SSI.L0 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSI ~ unemply:month + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_SSI.L0 %>% summary
plm_allmon_SSI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))



# 1mon lag
plm_allmon_SSI.L1 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSI ~ L1.unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)
plm_allmon_SSI.L1 %>% summary
plm_allmon_SSI.L1 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSI.L1 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_SSI.L1 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSI ~ L1.unemply + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_SSI.L1 %>% summary
plm_allmon_SSI.L1 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_SSI.L1 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSI ~ L1.unemply:month + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_SSI.L1 %>% summary
plm_allmon_SSI.L1 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSI.L1 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


# 2mon lag
plm_allmon_SSI.L2 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSI ~ L2.unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)
plm_allmon_SSI.L2 %>% summary
plm_allmon_SSI.L2 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSI.L1 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_SSI.L2 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSI ~ L2.unemply + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_SSI.L2 %>% summary
plm_allmon_SSI.L2 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSI.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_SSI.L2 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSI ~ L2.unemply:month + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_SSI.L2 %>% summary
plm_allmon_SSI.L2 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_SSI.L1 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))



# SSI -------------------------------------------------------------------------

# no lag
plm_allmon_conc.L0 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(conc ~ unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)
plm_allmon_conc.L0 %>% summary
plm_allmon_conc.L0 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
# plm_allmon_conc.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_conc.L0 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(conc ~ unemply + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_conc.L0 %>% summary
plm_allmon_conc.L0 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_conc.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_conc.L0 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(conc ~ unemply:month + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_conc.L0 %>% summary
plm_allmon_conc.L0 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_conc.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))



# 1mon lag
plm_allmon_conc.L1 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(conc ~ L1.unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)
plm_allmon_conc.L1 %>% summary
plm_allmon_conc.L1 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_conc.L1 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_conc.L1 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(conc ~ L1.unemply + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_conc.L1 %>% summary
plm_allmon_conc.L1 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_conc.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_conc.L1 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(conc ~ L1.unemply:month + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_conc.L1 %>% summary
plm_allmon_conc.L1 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_conc.L1 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


# 2mon lag
plm_allmon_conc.L2 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(conc ~ L2.unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)
plm_allmon_conc.L2 %>% summary
plm_allmon_conc.L2 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_conc.L1 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_conc.L2 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(conc ~ L2.unemply + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_conc.L2 %>% summary
plm_allmon_conc.L2 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_conc.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_conc.L2 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(conc ~ L2.unemply:month + tempF:month, model = "within", effect = "individual", data = .)
plm_allmon_conc.L2 %>% summary
plm_allmon_conc.L2 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
#plm_allmon_conc.L1 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))

```





## - **paper**: plm

```{r}

# UIIC -------------------------------------------------------------------------



# no lag
plm_allmon_UIIC.L0.u <-  
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(UIIC ~ unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)
#plm_allmon_UIIC.L0 %>% summary
#plm_allmon_UIIC.L0 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
# plm_allmon_UIIC.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))


plm_allmon_UIIC.L0.u.tm <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(UIIC ~ unemply + tempF:month, model = "within", effect = "individual", data = .)


plm_allmon_UIIC.L0.umtm <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(UIIC ~ unemply:month + tempF:month, model = "within", effect = "individual", data = .)




# SSDI -------------------------------------------------------------------------

# 1mon lag
plm_allmon_SSDI.L1.u <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSDI ~ L1.unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)


plm_allmon_SSDI.L1.u.tm <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSDI ~ L1.unemply + tempF:month, model = "within", effect = "individual", data = .)


plm_allmon_SSDI.L1.um.tm <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSDI ~ L1.unemply:month + tempF:month, model = "within", effect = "individual", data = .)


# 2mon lag
plm_allmon_SSDI.L2.u <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSDI ~ L2.unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)


plm_allmon_SSDI.L2.u.tm <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSDI ~ L2.unemply + tempF:month, model = "within", effect = "individual", data = .)


plm_allmon_SSDI.L2.um.tm <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSDI ~ L2.unemply:month + tempF:month, model = "within", effect = "individual", data = .)





# SSI -------------------------------------------------------------------------

# 1mon lag
plm_allmon_SSI.L1.u <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSI ~ L1.unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)


plm_allmon_SSI.L1.u.tm <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSI ~ L1.unemply + tempF:month, model = "within", effect = "individual", data = .)


plm_allmon_SSI.L1.um.tm <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSI ~ L1.unemply:month + tempF:month, model = "within", effect = "individual", data = .)


# 2mon lag
plm_allmon_SSI.L2.u <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSI ~ L2.unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)


plm_allmon_SSI.L2.u.tm <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSI ~ L2.unemply + tempF:month, model = "within", effect = "individual", data = .)


plm_allmon_SSI.L2.um.tm <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(SSI ~ L2.unemply:month + tempF:month, model = "within", effect = "individual", data = .)


# Concurrent -------------------------------------------------------------------

# 1mon lag
plm_allmon_conc.L1.u <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(conc ~ L1.unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)


plm_allmon_conc.L1.u.tm <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(conc ~ L1.unemply + tempF:month, model = "within", effect = "individual", data = .)


plm_allmon_conc.L1.um.tm <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(conc ~ L1.unemply:month + tempF:month, model = "within", effect = "individual", data = .)


# 2mon lag
plm_allmon_conc.L2.u <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(conc ~ L2.unemply, model = "within", effect = "individual", index = c("month", "State"), data = .)


plm_allmon_conc.L2.u.tm <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(conc ~ L2.unemply + tempF:month, model = "within", effect = "individual", data = .)


plm_allmon_conc.L2.um.tm <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(conc ~ L2.unemply:month + tempF:month, model = "within", effect = "individual", data = .)



## Result tables ---------------------------------------------------------------


#plm_allmon_UIIC.L0 %>% summary
#plm_allmon_UIIC.L0 %>% summary(vcov = function(x) vcovHC(x, method = "white1"))
# plm_allmon_UIIC.L0 %>% summary(vcov = function(x) vcovHC(x, method = "arellano"))

summary_white1 <- function(x) summary(x, vcov = function(y) vcovHC(y, method = "white1"))





## Lables 

plm_covarNames.DI <- c("Unemployment: 1-month lag",
                       "Unemployment: 2-month lag",
                        paste0("Temperature(F): ", month.abb)
                      )

plm_covarNames.UI <- c("Unemployment",
                       "Unemployment: 1-month lag",
                        paste0("Temperature(F): ", month.abb)
                      )

## SSDI table

plm_allmon_SSDI.L1.u %>% summary_white1()
plm_allmon_SSDI.L2.u.tm %>% summary_white1()
plm_allmon_SSDI.L2.um.tm %>% summary_white1()


vcov.SSDI.L1.u     <- sqrt(diag(vcovHC(plm_allmon_SSDI.L1.u, method = "white1")))
vcov.SSDI.L1.u.tm  <- sqrt(diag(vcovHC(plm_allmon_SSDI.L1.u.tm, method = "white1")))
vcov.SSDI.L1.um.tm <- sqrt(diag(vcovHC(plm_allmon_SSDI.L1.um.tm, method = "white1")))

vcov.SSDI.L2.u     <- sqrt(diag(vcovHC(plm_allmon_SSDI.L2.u, method = "white1")))
vcov.SSDI.L2.u.tm  <- sqrt(diag(vcovHC(plm_allmon_SSDI.L2.u.tm, method = "white1")))
vcov.SSDI.L2.um.tm <- sqrt(diag(vcovHC(plm_allmon_SSDI.L2.um.tm, method = "white1")))

stargazer(plm_allmon_SSDI.L1.u,
          plm_allmon_SSDI.L2.u,
          plm_allmon_SSDI.L1.u.tm,
          plm_allmon_SSDI.L2.u.tm,
          #plm_allmon_SSDI.L1.um.tm,
          #plm_allmon_SSDI.L2.um.tm,
          
          se = list(vcov.SSDI.L1.u,
                    vcov.SSDI.L2.u,
                    vcov.SSDI.L1.u.tm,
                    vcov.SSDI.L2.u.tm
                    #vcov.SSDI.L1.um.tm,
                    #vcov.SSDI.L2.um.tm 
          ),
          
          align = TRUE, type = "text",
          #title = seaStr.gg_title,
          dep.var.labels = "SSDI only applications",
          covariate.labels= plm_covarNames.DI
          )



## SSI table

plm_allmon_SSI.L1.u %>% summary_white1()
plm_allmon_SSI.L2.u.tm %>% summary_white1()
plm_allmon_SSI.L2.um.tm %>% summary_white1()


vcov.SSI.L1.u     <- sqrt(diag(vcovHC(plm_allmon_SSI.L1.u, method = "white1")))
vcov.SSI.L1.u.tm  <- sqrt(diag(vcovHC(plm_allmon_SSI.L1.u.tm, method = "white1")))
vcov.SSI.L1.um.tm <- sqrt(diag(vcovHC(plm_allmon_SSI.L1.um.tm, method = "white1")))

vcov.SSI.L2.u     <- sqrt(diag(vcovHC(plm_allmon_SSI.L2.u, method = "white1")))
vcov.SSI.L2.u.tm  <- sqrt(diag(vcovHC(plm_allmon_SSI.L2.u.tm, method = "white1")))
vcov.SSI.L2.um.tm <- sqrt(diag(vcovHC(plm_allmon_SSI.L2.um.tm, method = "white1")))

stargazer(plm_allmon_SSI.L1.u,
          plm_allmon_SSI.L2.u,
          plm_allmon_SSI.L1.u.tm,
          plm_allmon_SSI.L2.u.tm,
          #plm_allmon_SSI.L1.um.tm,
          #plm_allmon_SSI.L2.um.tm,
          
          se = list(vcov.SSI.L1.u,
                    vcov.SSI.L2.u,
                    vcov.SSI.L1.u.tm,
                    vcov.SSI.L2.u.tm
                    #vcov.SSI.L1.um.tm,
                    #vcov.SSI.L2.um.tm 
          ),
          
          align = TRUE, type = "text",
          #title = seaStr.gg_title,
          dep.var.labels = "SSI only applications",
          covariate.labels= plm_covarNames.DI
          )


## Concurrent table

plm_allmon_conc.L1.u %>% summary_white1()
plm_allmon_conc.L2.u.tm %>% summary_white1()
plm_allmon_conc.L2.um.tm %>% summary_white1()


vcov.conc.L1.u     <- sqrt(diag(vcovHC(plm_allmon_conc.L1.u, method = "white1")))
vcov.conc.L1.u.tm  <- sqrt(diag(vcovHC(plm_allmon_conc.L1.u.tm, method = "white1")))
vcov.conc.L1.um.tm <- sqrt(diag(vcovHC(plm_allmon_conc.L1.um.tm, method = "white1")))

vcov.conc.L2.u     <- sqrt(diag(vcovHC(plm_allmon_conc.L2.u, method = "white1")))
vcov.conc.L2.u.tm  <- sqrt(diag(vcovHC(plm_allmon_conc.L2.u.tm, method = "white1")))
vcov.conc.L2.um.tm <- sqrt(diag(vcovHC(plm_allmon_conc.L2.um.tm, method = "white1")))

stargazer(plm_allmon_conc.L1.u,
          plm_allmon_conc.L2.u,
          plm_allmon_conc.L1.u.tm,
          plm_allmon_conc.L2.u.tm,
          #plm_allmon_conc.L1.um.tm,
          #plm_allmon_conc.L2.um.tm,
          
          se = list(vcov.conc.L1.u,
                    vcov.conc.L2.u,
                    vcov.conc.L1.u.tm,
                    vcov.conc.L2.u.tm
                    #vcov.conc.L1.um.tm,
                    #vcov.conc.L2.um.tm 
          ),
          
          align = TRUE, type = "text",
          #title = seaStr.gg_title,
          dep.var.labels = "conc only applications",
          covariate.labels= plm_covarNames.DI
          )


## UIIC table
plm_allmon_UIIC.L0.u %>% summary_white1()

vcov.UIIC.L0.u     <- sqrt(diag(vcovHC(plm_allmon_UIIC.L0.u, method = "white1")))
vcov.UIIC.L0.u.tm  <- sqrt(diag(vcovHC(plm_allmon_UIIC.L0.u.tm, method = "white1")))
vcov.UIIC.L0.um.tm <- sqrt(diag(vcovHC(plm_allmon_UIIC.L0.um.tm, method = "white1")))

# vcov.UIIC.L1.u     <- sqrt(diag(vcovHC(plm_allmon_UIIC.L1.u, method = "white1")))
# vcov.UIIC.L1.u.tm  <- sqrt(diag(vcovHC(plm_allmon_UIIC.L1.u.tm, method = "white1")))
# vcov.UIIC.L1.um.tm <- sqrt(diag(vcovHC(plm_allmon_UIIC.L1.um.tm, method = "white1")))

stargazer(plm_allmon_UIIC.L0.u,
          #plm_allmon_UIIC.L1.u,
          plm_allmon_UIIC.L0.u.tm,
          #plm_allmon_UIIC.L1.u.tm,
          #plm_allmon_UIIC.L1.um.tm,
          
          se = list(vcov.UIIC.L0.u,
                    vcov.UIIC.L0.u.tm),
          
          align = TRUE, type = "text",
          #title = seaStr.gg_title,
          dep.var.labels = "UI initial claims",
          covariate.labels= plm_covarNames.UI
          )





## UI and SSDI table

plm_covarNames.UISSDI <- c("Unemployment",
                          "Unemployment: 1-month lag",
                          "Unemployment: 2-month lag",
                           paste0("Temperature(F): ", month.abb)
                      )

stargazer(plm_allmon_UIIC.L0.u,
          plm_allmon_UIIC.L0.u.tm,
          plm_allmon_SSDI.L1.u,
          plm_allmon_SSDI.L2.u,
          plm_allmon_SSDI.L1.u.tm,
          plm_allmon_SSDI.L2.u.tm,

          se = list(vcov.UIIC.L0.u,
                    vcov.UIIC.L0.u.tm,
                    vcov.SSDI.L1.u,
                    vcov.SSDI.L2.u,
                    vcov.SSDI.L1.u.tm,
                    vcov.SSDI.L2.u.tm),
          
          align = TRUE, type = "text",
          #title = seaStr.gg_title,
          dep.var.labels = "UI initial claims",
          covariate.labels= plm_covarNames.UISSDI,
          order = c(1, 14, 15, 2:13)
          )

## Multicollinearity issue

calc_vif <- function(rsqd) 1/(1-rsqd)

plm_mc0 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(unemply ~ tempF:month, model = "within", effect = "individual", data = .)

summary(plm_mc0)$r.squared[1] %>% calc_vif


plm_mc1 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(L1.unemply ~ tempF:month, model = "within", effect = "individual", data = .)

summary(plm_mc1)$r.squared[1] %>% calc_vif


plm_mc2 <- 
  df_reg_allmon_states %>% 
  filter(!State %in% c("AK", "HI", "DC")) %>% 
  plm(L2.unemply ~ tempF:month, model = "within", effect = "individual", data = .)

summary(plm_mc2)$r.squared[1] %>% calc_vif




```










# Regression: seasonal pattern (two peaks)

## - Constructing variables
```{r}

# LHS vars: for SSDI, SDI, and conc
#  - Spring peak 1: seasonal factor in March
#  - Spring peak 2: Avg seasonal factor from March to May
#  - Auguest peak
#  - pattern 1: Spring peak 1 / August peak
#  - pattern 2: Spring peak 2 / August peak 

# RHS var
#  - unemployment:
#     - seasonal factor in Dec, Jan, Feb, and July
#  - Temperature:
#     - avg temp in Jan and Feb
#     - avg temp in July and Aug
#  - Industrial structure
#      - share of construction
#      - share of highest 5
#      - share of modest 4
#      - share of farm


df_reg_pattern <- 
    ls_ets$df_comp_ets %>% 
    filter(.model %in% c("SSDI", "SSI", "conc", "unemply", "dlunemply", "UIIC",
                         
                         # employment: monthly level
                         "emplyMon_tot", "emplyMon_construction", "emplyMon_leisure",
                         "emplyMon_mining", "emplyMon_trade", "emplyMon_gov",
                         "emplyMon_high5",  "emplyMon_modest4", "employment_modest2",
                         
                         # employment: monthly % change
                         "dlemplyMon_tot",    "dlemplyMon_construction", "dlemplyMon_leisure",
                         "dlemplyMon_mining", "dlemplyMon_trade",        "dlemplyMon_gov",
                         "dlemplyMon_high5",  "dlemplyMon_modest4",      "dlemployment_modest2"
                         )) %>% 
    as_tibble %>% 
    filter(!is.na(season)) %>% 
    mutate(month = month(date_yearmon)) %>% 
    group_by(State, .model, month) %>% 
    # average seasonal factors across years
    summarise(season_avg = mean(season, na.rm = TRUE), .groups = "drop_last") %>% 
    mutate(month = paste0("s", month)) %>% 
    unite(col = "Var", .model, month, sep = "_") %>% 
    spread(Var, season_avg) %>% 
    mutate(SSDI_s3to5 = (SSDI_s3 + SSDI_s4 + SSDI_s5)/3,
           SSI_s3to5  = (SSI_s3  + SSI_s4  + SSI_s5)/3,
           conc_s3to5 = (conc_s3 + conc_s4 + conc_s5)/3,
           
           unemply_s1to3 = (unemply_s3 + unemply_s4 + unemply_s5)/3,
           
           
           # SSDI_pattern1 = SSDI_s3 / SSDI_s8,
           # SSI_pattern1  = SSI_s3  / SSI_s8,
           # conc_pattern1 = conc_s3 / conc_s8,
           # 
           # SSDI_pattern2 = SSDI_s3to5 / SSDI_s8,
           # SSI_pattern2  = SSI_s3to5  / SSI_s8,
           # conc_pattern2 = conc_s3to5 / conc_s8,
           
           UIIC_s12to1 = (UIIC_s12 + UIIC_s1)/2,
           UIIC_s7to8  = (UIIC_s7 + UIIC_s8)/2
           
           
           
           )


df_temp_monAvg_wide <-   
  df_temp_monAvg %>% 
  mutate(Month = paste0("tempF_", Month )) %>% 
  spread(Month, tempF) %>% 
  mutate(tempF_1to2 = (tempF_1 + tempF_2) / 2,
         tempF_7to8 = (tempF_7 + tempF_8) / 2,
         
         tempF_12to1 = (tempF_12 + tempF_1) / 2,
         tempF_11to1 = (tempF_11 + tempF_12 + tempF_1) / 3,
         tempF_7to8  = (tempF_7 + tempF_8)  / 2,
         tempF_6to8  = (tempF_6 +  tempF_7 + tempF_8)  / 3,
         
         tempF_1to3 = (tempF_1 + tempF_2 + tempF_3) / 3,
         tempF_3to5 = (tempF_3 + tempF_4 + tempF_5) / 3,
         tempF_1to5 = (tempF_1 + tempF_2 + tempF_3 + tempF_4 + tempF_5) / 5
         )


# df_emplyInd_share # ready to use

df_reg_pattern %<>% 
  left_join(df_temp_monAvg_wide, by = "State") %>% 
  left_join(df_emplyInd_share,   by = "State")

df_reg_pattern1 <-  
  df_reg_pattern %>% 
  filter(State %in% c(state.abb, "DC") )

```



## -  **paper**: Figures: temperature vs peaks
```{r}

## Winter/Spring Peak
library(ggrepel)

seed_repel <- 1234


df_reg_pattern_con48 <- 
  df_reg_pattern1 %>% filter(!State %in% c("AK", "HI", "DC"))


# unemployment
(reg <- 
  df_reg_pattern_con48 %>% 
  lm(unemply_s1to3~ tempF_1to3, data = .) %>% 
  summary)

slope <- round(reg$coefficients[2,1], 4)
r2    <- round(reg$r.squared, 2)
corcoef <- round(with(df_reg_pattern_con48, cor(unemply_s1to3, tempF_1to3)), 2)

fig_text <- glue("Slope = {slope} (p<0.01)\nR-squared = {r2}\nCorrelation = {corcoef} ")

fig_peak1_unemp <-   
  df_reg_pattern1 %>%
  #filter(!State %in% c("AK")) %>%
  ggplot(aes(x = tempF_1to3, y = unemply_s1to3, label = State)) + theme_bw() + 
  geom_point() + 
  geom_text_repel(size = 3, seed = seed_repel) + 
  geom_smooth(method='lm', data = filter(df_reg_pattern1, !State %in% c("AK", "HI", "DC"))) + 
  geom_hline(yintercept = 1, linetype = 2, color = "gray70") + 
  coord_cartesian(ylim = c(0.9, 1.25)) + 
  annotate("text", x = 55, y = 1.21, label = fig_text,  size = 3.5) +
  scale_x_continuous(breaks=seq(-100, 100, 10)) + 
  scale_y_continuous(breaks=seq(0, 3, 0.05)) + 
  labs(title = "Jan-Mar peak of unemployment",
       x = "Average temperature (F)",
       y = "Average seasonal factor")
fig_peak1_unemp 


# SSDI 
(reg <- 
  df_reg_pattern_con48 %>% 
  lm(SSDI_s3to5~ tempF_3to5, data = .) %>% 
  summary)

slope <- round(reg$coefficients[2,1], 4)
r2    <- round(reg$r.squared, 2)
corcoef <- round(with(df_reg_pattern_con48, cor(SSDI_s3to5, tempF_3to5)), 2)

fig_text <- glue("Slope = {slope} (p<0.01)\nR-squared = {r2}\nCorrelation = {corcoef} ")

fig_peak1_SSDI <- 
  df_reg_pattern1 %>%
  #filter(!State %in% c("AK")) %>%
  ggplot(aes(x = tempF_3to5, y = SSDI_s3to5, label = State)) + theme_bw() +
  geom_point() + 
  geom_text_repel(size = 3, seed = seed_repel) + 
  geom_smooth(method='lm', data = filter(df_reg_pattern1, !State %in% c("AK", "HI", "DC"))) +
  geom_hline(yintercept = 1, linetype = 2, color = "gray70") + 
  coord_cartesian(ylim = c(0.9, 1.25)) + 
  annotate("text", x = 65, y = 1.21, label = fig_text,  size = 3.5) +
  scale_x_continuous(breaks=seq(-100, 100, 10)) + 
  scale_y_continuous(breaks=seq(0, 3, 0.05)) + 
  
  labs(title = "Mar-May peak of SSDI only applications",
       x = "Average temperature (F)",
       y = "Average seasonal factor")
fig_peak1_SSDI 


# UIIC  
(reg <- 
  df_reg_pattern_con48 %>% 
  lm(UIIC_s12to1~ tempF_12to1, data = .) %>% 
  summary)

slope <- round(reg$coefficients[2,1], 4)
r2    <- round(reg$r.squared, 2)
corcoef <- round(with(df_reg_pattern_con48, cor(UIIC_s12to1, tempF_12to1)), 2)

fig_text <- glue("Slope = {slope} (p<0.01)\nR-squared = {r2}\nCorrelation = {corcoef} ")

fig_peak1_UIIC <- 
  df_reg_pattern1 %>%
  #filter(!State %in% c("AK")) %>%
  ggplot(aes(x = tempF_12to1, y = UIIC_s12to1, label = State )) + theme_bw() +
  geom_point() + 
  geom_text_repel(size = 3, seed = seed_repel) + 
  geom_smooth(method='lm', data = filter(df_reg_pattern1, !State %in% c("AK", "HI", "DC"))) +
  geom_hline(yintercept = 1, linetype = 2, color = "gray70") + 
  annotate("text", x = 54, y = 1.8, label = fig_text,  size = 3.5) +
  coord_cartesian(ylim = c(0.5, 1.9)) + 
  scale_x_continuous(breaks=seq(-100, 100, 10)) + 
  scale_y_continuous(breaks=seq(0, 3, 0.1)) + 
  labs(
       title = "Dec-Jan peak of UI initial claims",
       x = "Average temperature (F)",
       y = "Average seasonal factor")
fig_peak1_UIIC    



## Summer peak

# unemployment

(reg <- 
  df_reg_pattern_con48 %>% 
  lm(unemply_s7 ~ tempF_7, data = .) %>% 
  summary)

slope <- round(reg$coefficients[2,1], 4)
r2    <- round(reg$r.squared, 2)
corcoef <- round(with(df_reg_pattern_con48, cor(unemply_s7, tempF_7)), 2)

fig_text <- glue("Slope = {slope} (p<0.01)\nR-squared = {r2}\nCorrelation = {corcoef} ")

fig_peak2_unemp <- 
  df_reg_pattern1 %>%
  filter(!State %in% c("AK")) %>%
  ggplot(aes(x = tempF_7, y = unemply_s7, label = State )) + theme_bw() + 
  geom_point() + 
  geom_smooth(method='lm', data = df_reg_pattern_con48)+ 
  annotate("text", x = 81, y = 1.21, label = fig_text,  size = 3.5) +
  geom_text_repel(size = 3, seed = seed_repel) + 
  geom_hline(yintercept = 1, linetype = 2, color = "gray70") + 
  coord_cartesian(ylim = c(0.9, 1.25)) + 
  scale_x_continuous(breaks=seq(-100, 100, 5)) + 
  scale_y_continuous(breaks=seq(0, 3, 0.05)) + 
  geom_smooth(method='lm') + 
  labs(
       title = "Jul peak of unemployment",
       x = "Average temperature (F)",
       y = "Average seasonal factor")

fig_peak2_unemp 



# SSDI

(reg <- 
  df_reg_pattern_con48 %>% 
  lm(SSDI_s8 ~ tempF_8, data = .) %>% 
  summary)

slope <- round(reg$coefficients[2,1], 4)
r2    <- round(reg$r.squared, 2)
corcoef <- round(with(df_reg_pattern_con48, cor(SSDI_s8, tempF_8)), 2)

fig_text <- glue("Slope = {slope} (p<0.01)\nR-squared = {r2}\nCorrelation = {corcoef} ")

fig_peak2_SSDI <- 
  df_reg_pattern1 %>%
  filter(!State %in% c("AK")) %>%
  ggplot(aes(x = tempF_8, y = SSDI_s8, label = State)) + theme_bw() +
  geom_point() + 
  geom_smooth(method='lm')+ 
  geom_text_repel(size = 3, seed = seed_repel) + 
  geom_hline(yintercept = 1, linetype = 2, color = "gray70") + 
  annotate("text", x = 81, y = 1.21, label = fig_text, size = 3.5) +
  coord_cartesian(ylim = c(0.9, 1.25)) + 
  scale_x_continuous(breaks=seq(-100, 100, 5)) + 
  scale_y_continuous(breaks=seq(0, 3, 0.05)) + 
  labs(
       title = "Aug peak of SSDI only applications",
       x = "Average temperature (F)",
       y = "Average seasonal factor")
fig_peak2_SSDI




# UIIC

(reg <- 
  df_reg_pattern_con48 %>% 
  lm(UIIC_s7 ~ tempF_7, data = .) %>% 
  summary)

slope <- round(reg$coefficients[2,1], 4)
r2    <- round(reg$r.squared, 2)
corcoef <- round(with(df_reg_pattern_con48, cor(UIIC_s7, tempF_7)), 2)

fig_text <- glue("Slope = {slope} (p<0.01)\nR-squared = {r2}\nCorrelation = {corcoef} ")


fig_peak2_UIIC <- 
  df_reg_pattern1 %>%
  filter(!State %in% c("AK")) %>%
  ggplot(aes(x = tempF_7, y = UIIC_s7, label = State )) + theme_bw() +
  geom_point() + 
  geom_smooth(method='lm') + 
  geom_text_repel(size = 3, seed = seed_repel) + 
  geom_hline(yintercept = 1, linetype = 2, color = "gray70") + 
  annotate("text", x = 81, y = 1.8, label = fig_text,  size = 3.5) +
  coord_cartesian(ylim = c(0.5, 1.9)) + 
  scale_x_continuous(breaks=seq(-100, 100, 5)) + 
  scale_y_continuous(breaks=seq(0, 3, 0.1)) + 
  labs(
       title = "Jul-Aug peak of UI initial claims",
       x = "Average temperature (F)",
       y = "Average seasonal factor")


fig_peaks_unemp <- 
  marrangeGrob(
    list(fig_peak1_unemp, fig_peak2_unemp), nrow = 1, ncol = 2, top = "Unemployment")

fig_peaks_SSDI <- 
  marrangeGrob(
    list(fig_peak1_SSDI, fig_peak2_SSDI), nrow = 1, ncol = 2, top = "SSDI application")

fig_peaks_UIIC <- 
  marrangeGrob(
    list(fig_peak1_UIIC, fig_peak2_UIIC), nrow = 1, ncol = 2, top = "UI initial claims")


# fig_peaks_unemp
# fig_peaks_SSDI
# fig_peaks_UIIC

ggsave(
  paste0(plot.path, "fig_newVer/fig_peaksTemp_unemp.png"), 
  fig_peaks_unemp,
  width = 11, height = 4, scale = 1.1
 )

ggsave(
  paste0(plot.path, "fig_newVer/fig_peaksTemp_SSDI.png"), 
  fig_peaks_SSDI,
  width = 11, height = 4, scale = 1.1
 )

ggsave(
  paste0(plot.path, "fig_newVer/fig_peaksTemp_UIIC.png"), 
  fig_peaks_UIIC,
  width = 11, height = 4, scale = 1.1
 )


``` 




# - run regression: unemply and temperature
```{r}

# UI as a reference

df_reg_pattern1 %>% 
   filter(!State %in% c("AK")) %>% 
   lm(UIIC_s12to1 ~ unemply_s12 + unemply_s1 + tempF_12to1, data = .) %>% 
   summary()
# Nov is not significant. Dec and Jan not very robust, but at least one is signficant
# Temperature is almost always signficant and negative (the colder the more UI application)


df_reg_pattern1 %>% 
   filter(!State %in% c("AK")) %>% 
   lm(UIIC_s7 ~ unemply_s7 + tempF_7to8, data = .) %>%  # robust to tempF 7, 8 or 7to8
   summary() 
# result sensitive to MI, unemployment not significant once MI is removed
# temperature is always significant, and positive (the warmer the more UI application)


df_reg_pattern1 %>% 
   filter(!State %in% c("AK")) %>% 
   lm(UIIC_s8 ~  unemply_s7 + unemply_s8 + tempF_7to8, data = .) %>% 
   summary()
# Monthly change of unemployment in July is significant, but level is not (but July and Aug may be jointly signficant)
# not sig for level of employment
# temperature is always significant, and positive (the warmer the more UI application)



# Three types of DI applications
df_reg_pattern1 %>% 
   filter(!State %in% c("AK")) %>% 
   lm(SSDI_s3to5 ~   unemply_s1 + unemply_s2 + tempF_1to2, data = .) %>% 
   summary()

df_reg_pattern1 %>% 
   filter(!State %in% c("AK")) %>% 
   lm(SSI_s3to5  ~  unemply_s1 + unemply_s2 + tempF_1to2, data = .) %>% 
   summary()

df_reg_pattern1 %>% 
   filter(!State %in% c("AK")) %>% 
   lm(conc_s3to5 ~  unemply_s1 + unemply_s2 + tempF_1to2, data = .) %>% 
   summary()
# Temperature is always signficant and negative (the colder the more DI application), coeff much smaller than in UI
# Unemployment is mostly not significant at 5%, exceptions are
#   - SSDI, Feb when using monthly change
#   - SSDI, Jan when using level


df_reg_pattern1 %>% 
   filter(!State %in% c("AK")) %>% 
   lm(SSDI_s8 ~ dlunemply_s6 + dlunemply_s7 + tempF_7to8, data = .) %>% 
   summary()

df_reg_pattern1 %>% 
   filter(!State %in% c("AK")) %>% 
   lm(SSI_s8  ~ dlunemply_s6 + dlunemply_s7 + tempF_7to8, data = .) %>% 
   summary()

df_reg_pattern1 %>% 
   filter(!State %in% c("AK")) %>% 
   lm(conc_s8 ~ dlunemply_s6 + dlunemply_s7 + tempF_7to8, data = .) %>% 
   summary()

# Temperature is always signficant and positive (the warmer the more UI application), coeff smaller than in UI
# Unemployment is not significant at 5%, either level or monthly change



```


# - run regression: industry specific employment and temperature
```{r}

# Spring peak
# including AK or not produces very different results

df_reg_pattern1 %>% 
   filter(!State %in% c("DE", "HI", "AK")) %>% 
   lm(SSDI_s3to5 ~ emplyMon_construction_s1 + emplyMon_construction_s2 +
                   # emplyMon_modest4_s1 + emplyMon_modest4_s2 + 
                   tempF_1to2, 
                   data = .) %>% 
   summary()



df_reg_pattern1 %>% 
   filter(!State %in% c("DE", "HI", "AK")) %>% 
   lm(SSI_s3to5  ~ emplyMon_construction_s1 + emplyMon_construction_s2+ 
                   # emplyMon_modest4_s1 + emplyMon_modest4_s2 + 
                   tempF_1to2, 
      data = .) %>% 
   summary()


df_reg_pattern1 %>% 
   filter(!State %in% c("DE", "HI", "AK")) %>% 
   lm(conc_s3to5 ~ emplyMon_construction_s1 + emplyMon_construction_s2 +
                   # emplyMon_modest4_s1 + emplyMon_modest4_s2 + 
                   tempF_1to2, 
      data = .) %>% 
   summary()
# Including AK makes Mon, Feb of construction sig for some


## Aug peak 

df_reg_pattern1 %>% 
   filter(!State %in% c("AK" )) %>% 
   lm(SSDI_s8 ~ emplyMon_construction_s6 + emplyMon_construction_s7 + 
                emplyMon_modest4_s6 + emplyMon_modest4_s7 +
                #emplyMon_gov_s6 + emplyMon_gov_s7 + 
                tempF_7to8, 
                data = .) %>% 
   summary()


df_reg_pattern1 %>% 
   filter(!State %in% c("AK")) %>% 
   lm(SSI_s8  ~ emplyMon_construction_s6 + emplyMon_construction_s7 + 
                emplyMon_modest4_s6 + emplyMon_modest4_s7 +  
                tempF_7to8, data = .) %>% 
   summary()

df_reg_pattern1 %>% 
   filter(!State %in% c("AK")) %>% 
   lm(conc_s8 ~ emplyMon_construction_s6 + emplyMon_construction_s7 + 
                emplyMon_modest4_s6 + emplyMon_modest4_s7 + 
                tempF_7to8, data = .) %>% 
   summary()

# Mostly not sigificant, even for temperature, but RHS vars are joinly signficant (see F test)






```







