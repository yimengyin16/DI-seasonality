---
title: "Exploring possible causes of seasonality in DI applications"
output:
  pdf_document:
    includes:
      in_header: LatexPreamble.sty
    number_sections: yes
editor_options: 
  chunk_output_type: console
---

```{r preamble, include=FALSE}

library(plyr)
library(ggplot2)
library(scales)
library(xtable)
#library(DataCombine) # it loads dplyr!
library(magrittr)
library("tidyr")
library("knitr")
library(lubridate)
library(tsibble)
library(fable)
library(feasts)
library(dplyr)
library(purrr)
library(grid)
library(gridExtra)
library(magrittr)

options(xtable.include.rownames = F,
        xtable.booktabs = T,
        xtable.caption.placement = "top")

source("General.R")
select <- dplyr::select

plot.path = "paper_plot/"
dir.fig_newVer = "paper_plot/fig_newVer/"


##' This analysis depends on the following inputs
# 
#'   1. Data/intermed_ets.rds (generated by Seasonality.Pattern.Rmd - modeling seasonality)
#'        - A list containing the following elements
#           - Panel_all: Panel data up to the most recent date
#'          - Panel:     Panel data up to Feb 2020
#'          - mod_ets:   ets model results for all variables of interest
#'          - df_comp_ets: decomposed time series extracted from mod_ets
#
#'   2. Data/emplyIndustry.RData (generated by Data.import.BEA.R)
#'        - df_emplyInd: annual employment data by industry and state
#'          (no national, need to generate in this script)
#
#'   3. Data/temperature.RData (generated by Data.import.temperature.R)
#'        - df_temperature: monthly average temperature (F) by state 
#'          (national for contiguous 48 states)


ls_ets <- readRDS("Data/intermed_ets.rds")
(load("Data/emplyIndustry.RData")) # df_emplyInd
(load("Data/temperature.RData"))   # df_temperature   


```


## Preparing temperature and employment structure data for regression
```{r include=FALSE}

# Prep 1: temperature 
#   - calculate average monthly temperature from 2000-2020
#   - output: 49 states excluding Hawaii, and national (48 contiguous states) (50 regions)

df_temp_monAvg <- 
  df_temerature %>% 
  filter(year %in% 2000:2020) %>% 
  group_by(state_abb, month) %>% 
  summarise(tempF = mean(tempF, na.rm = TRUE),
            .groups = "drop_last") %>% 
  rename(State = state_abb,
         Month = month)

df_temp_yrAvg <- 
  df_temp_monAvg %>% 
  group_by(State) %>% 
  summarise(tempF = mean(tempF, na.rm = TRUE))
  


# Prep 2: employment by industry and state
#   - Create the following variables
#     - emply_leisure: emply_accomm + emply_entertain
#     - emply_highSea5:   emply_construction + emply_retail + emply_gov + emply_leisure + emply mining
#     - emply_modestSea4: emply_highSea5 excluding construction
#   - Also create shares in total employment for the following vars
#     - emply_construction, emply_retail, emply_gov,  emply_leisure, emply mining
#     - emply_highSea5, emply_modestSea4,
#     - emply_farm
#
#   - Create a new data frame containing mean shares (across 2000-2020) of key variables 
#   - Output contains 50 states + DC + national (52 regions)


df_emplyInd %<>% 
  mutate(emply_leisure    = emply_accomm + emply_entertain,
         emply_highSea5   = emply_construction + emply_retail + emply_gov + emply_leisure + emply_mining,
         emply_modestSea4 = emply_highSea5 - emply_construction,
         
         emplyShare_construction = emply_construction / emply_Tot,
         emplyShare_retail       = emply_retail/ emply_Tot,
         emplyShare_gov          = emply_gov/ emply_Tot,
         emplyShare_leisure      = emply_leisure/ emply_Tot, 
         emplyShare_mining       = emply_mining / emply_Tot,
         emplyShare_highSea5     = emply_highSea5/ emply_Tot, 
         emplyShare_modestSea4   = emply_modestSea4/ emply_Tot,
         emplyShare_farm         = emply_farm/ emply_Tot
         )

df_emplyInd_share <- 
  df_emplyInd %>% 
  filter(year %in% 2000:2020) %>% 
  group_by(State) %>% 
  summarise(across(starts_with("emplyShare"), ~ mean(.x, na.rm = TRUE)))

df_emplyInd_share$State %>% unique() %>% length

```


## Computing seasonal strength

```{r include=FALSE}

# Computing seasonal strength measures in two ways
#   1. Variance-based measure
#       - https://otexts.com/fpp3/stlfeatures.html
#       - max(0, Var(residual) / var(season + residual) )
#   2. SD of average seasonal factor (similar to Geremew & Gourio(2018))
#       - Calculate average seasonal factor across years (season)
#       - Standard deviation (w/ denominator n) of the average seasonal factors


# Note that these two seasonal strength measures serve different purposes
#   - The variance-based measure. It measures how the seasonal variation compares to 
#     the detrended variation. It demonstrates the relative importance of the seasonal 
#     varation in the overall detrended variation
#   - SD of seasonal factors. This measure does not involve any comparison with other 
#     component of the series. Rather, it measures the overall magnitude of the seasonal
#     component itself. 
#  
#   - This two measures may NOT be correlated. For example, a series may have a 
#     prominent seasonal pattern (high SD seasonal factor), but the seasonal variation 
#     may only account for a small proportion of the overall (detrended) variation due to 
#     a highly volatile residual (error) component. 

#   - For the paper
#      -  The first measure can be used to justify the importance of seasonality
#      -  The second one is more appropriate to use in the regression analysis. (as did in GG(2018))

# Outputs:
#   - 50 states + national (US) + 10 SSA regions (61) 



# Population versions for variance and standard deviation
pop.var <- function(x,...) var(x, ...) * (length(x)-1) / length(x)
pop.sd  <- function(x,...) sqrt(pop.var(x))


# 1 variace based measure
df_seaStr_var <- 
  ls_ets$df_comp_ets %>% 
  as_tibble %>% 
  filter(!is.na(remainder), !is.na(season)) %>% 
  group_by(State, .model) %>% 
  summarise(var_SR = pop.var(season + remainder, na.rm = TRUE),
            var_R  = pop.var(remainder, na.rm = TRUE),
            .groups = "drop") %>% 
  mutate(seaStr_var = pmax(0, 1 - var_R/var_SR))
  


# 2 SD of average seasonal factor
df_seaStr_gg <- 
  ls_ets$df_comp_ets %>% 
  as_tibble %>% 
  filter(!is.na(remainder), !is.na(season)) %>% 
  mutate(month = month(date_yearmon)) %>% 
  group_by(State, .model, month) %>% 
  # average seasonal factors across years
  summarise(season_avg = mean(season, na.rm = TRUE), .groups = "drop_last") %>% 
  # SD (pop) of seasonal factors across month
  summarise(seaStr_gg  = pop.sd(season_avg), .groups = "drop")
  

# merging measures
df_seaStr <- 
  left_join(df_seaStr_var, df_seaStr_gg, by = c("State", ".model"))
  


## Check if the two measures are correlated 
df_seaStr %>% 
  group_by(.model) %>% 
  summarise(str_corr = cor(seaStr_var, seaStr_gg))
# Modereate correlation for unemployment and UI
# Little or week correlation for DI variables. 
# Almost no correlation for DI applications.

# df_seaStr$State %>% unique()


```



# Regression: strengh of seasonality

This section explore the determinants of the strength of seasonality (measured by SD seasonal factor)

We consider the following RHS variables:

- Seasonal strength of unemployment 
   - unemployment (unemply)
   - or, dunemply, dlunemply
- Temperature
- Industrial structure measures
  - share of construction
  - share of highest 5
  - share of modest 4
  - share of farm


In theory, the impact of industrial structure should be already reflected in the strength of unemployment 


## Exploratory regressions, all states

```{r}

## combining data

df_reg_seaStr <- 
# left_join(
  df_seaStr %>% 
    filter(.model %in% c("SSDI", "SSI", "conc", "unemply", "dlunemply", "dunemply", "UIIC")) %>% 
    select(-var_SR, -var_R) %>% 
    gather(Var, value, -State,-.model) %>% 
    unite(col = "Var", Var, .model, sep = ".") %>% 
    spread(Var, value) %>% 
  
  # df_seaStr %>% 
  #   filter(.model %in% c("unemply", "dlunemply", "dunemply")) %>% 
  #   select(-var_SR, -var_R) %>% 
  #   gather(Var, value, -State,-.model) %>% 
  #   unite(col = "Var", Var, .model, sep = ".") %>% 
  #   spread(Var, value),
  # by = "State"
  # %>% 
  left_join(df_temp_yrAvg, by = "State") %>% 
  left_join(df_emplyInd_share, by = "State")

df_reg_seaStr1 <- 
  df_reg_seaStr %>% filter(State %in% state.abb)

names(df_reg_seaStr)
df_reg_seaStr$State %>% unique


## Plotting the correlation
# DI
df_reg_seaStr1 %>% 
  filter(State %in% state.abb) %>% 
  ggplot(aes(x = seaStr_gg.unemply, y = seaStr_gg.SSDI)) + 
  geom_point()


df_reg_seaStr1 %>% 
  filter(State %in% state.abb) %>% 
  ggplot(aes(x = tempF, y = seaStr_var.SSDI)) + 
  geom_point()


df_reg_seaStr1 %>% 
  filter(State %in% state.abb) %>% 
  ggplot(aes(x = emplyShare_modestSea4, y = seaStr_gg.SSDI)) + 
  geom_point()


# UIIC
df_reg_seaStr1 %>% 
  filter(State %in% state.abb) %>% 
  ggplot(aes(x = seaStr_gg.unemply, y = seaStr_gg.UIIC)) + 
  geom_point()

df_reg_seaStr1 %>% 
  filter(State %in% state.abb) %>% 
  ggplot(aes(x = seaStr_var.dunemply, y = seaStr_var.UIIC)) + 
  geom_point()

df_reg_seaStr1 %>% 
  filter(State %in% state.abb) %>% 
  ggplot(aes(x = tempF, y = seaStr_gg.UIIC)) + 
  geom_point()



## regressions w/o industrial structure
# gg strength
df_reg_seaStr1 %>% 
  lm(seaStr_gg.SSDI ~ seaStr_gg.unemply + tempF, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_gg.SSI ~ seaStr_gg.unemply + tempF, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_gg.conc ~ seaStr_gg.unemply + tempF, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_gg.UIIC ~ seaStr_gg.unemply + tempF, data = .) %>% 
  summary()
# DI:
#   - unemployment is not significant, (level, difference, growth)
#   - tempF is significant only for SSI, the estimate is very low and negative
# UIIC
#   - employment is significant and greater than 1
#   - temperature is also significant and is negative


# Var strength
df_reg_seaStr1 %>% 
  lm(seaStr_var.SSDI ~ seaStr_var.unemply + tempF, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_var.SSI ~ seaStr_var.dunemply + tempF, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_var.conc ~ seaStr_var.unemply + tempF, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_var.UIIC ~ seaStr_var.unemply + tempF, data = .) %>% 
  summary()
# DI: 
#  - unemployment is not significant 
#  - Temperature is significant and positive
# UIIC:
#  - unemployment is not significant
#  - Temerature is significant but negative


## regressions w/o industrial structure
# gg strength
df_reg_seaStr1 %>% 
  lm(seaStr_gg.SSDI ~ seaStr_gg.unemply + tempF + emplyShare_construction + emplyShare_modestSea4 + emplyShare_farm, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_gg.SSI  ~ seaStr_gg.dunemply + tempF + emplyShare_construction + emplyShare_modestSea4 + emplyShare_farm, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_gg.conc ~ seaStr_gg.unemply + tempF + emplyShare_construction + emplyShare_modestSea4 + emplyShare_farm, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_gg.UIIC ~ seaStr_gg.unemply + tempF + emplyShare_construction + emplyShare_modestSea4 + emplyShare_farm, data = .) %>% 
  summary()

#DI
#  - the three employment share variables have mixed significance.
#  - generally the shares of construction and farm are negative, and modestSea4 is possitive
# UIIC
#  - unemployment and temperature are still significant. 
#  - shares have similar results as DI


# Var strength
df_reg_seaStr1 %>% 
  lm(seaStr_var.SSDI ~ seaStr_var.unemply + tempF + emplyShare_construction + emplyShare_modestSea4 + emplyShare_farm, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_var.SSI ~ seaStr_var.dunemply + tempF + emplyShare_construction + emplyShare_modestSea4 + emplyShare_farm, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_var.conc ~ seaStr_var.unemply + tempF + emplyShare_construction + emplyShare_modestSea4 + emplyShare_farm, data = .) %>% 
  summary()

df_reg_seaStr1 %>% 
  lm(seaStr_var.UIIC ~ seaStr_var.unemply + tempF + emplyShare_construction + emplyShare_modestSea4 + emplyShare_farm, data = .) %>% 
  summary()


```


## Exploratory regressions, large states and regions
```{r}
# 
df_reg_seaStr %>% 
  filter(State %in% regionNames) %>% 
  ggplot(aes(x = seaStr_gg.unemply, y = seaStr_gg.SSDI)) + 
  geom_point()
  
df_reg_seaStr %>% 
  filter(State %in% regionNames) %>% 
  ggplot(aes(x = seaStr_gg.unemply, y = seaStr_gg.SSI)) + 
  geom_point()

df_reg_seaStr %>% 
  filter(State %in% regionNames) %>% 
  ggplot(aes(x = seaStr_gg.unemply, y = seaStr_gg.conc)) + 
  geom_point()

df_reg_seaStr %>% 
  filter(State %in% regionNames) %>% 
  ggplot(aes(x = seaStr_gg.unemply, y = seaStr_gg.UIIC)) + 
  geom_point()


df_reg_seaStr %>% 
  filter(State %in% regionNames) %>% 
  arrange( seaStr_gg.SSDI) %>% 
  select("State", contains("_var."))

df_reg_seaStr %>% 
  filter(State %in% regionNames) %>% 
  arrange(seaStr_gg.SSDI) %>% 
  select("State", contains("_gg."))


```




# Regression: seasonal pattern (two peaks)

## Constructing variables
```{r}

# LHS vars: for SSDI, SDI, and conc
#  - Spring peak 1: seasonal factor in March
#  - Spring peak 2: Avg seasonal factor from March to May
#  - Auguest peak
#  - pattern 1: Spring peak 1 / August peak
#  - pattern 2: Spring peak 2 / August peak 

# RHS var
#  - unemployment:
#     - seasonal factor in Dec, Jan, Feb, and July
#  - Temperature:
#     - avg temp in Jan and Feb
#     - avg temp in July and Aug
#  - Industrial structure
#      - share of construction
#      - share of highest 5
#      - share of modest 4
#      - share of farm


df_reg_pattern <- 
    ls_ets$df_comp_ets %>% 
    filter(.model %in% c("SSDI", "SSI", "conc", "unemply", "dunemply", "UIIC")) %>% 
    as_tibble %>% 
    filter(!is.na(season)) %>% 
    mutate(month = month(date_yearmon)) %>% 
    group_by(State, .model, month) %>% 
    # average seasonal factors across years
    summarise(season_avg = mean(season, na.rm = TRUE), .groups = "drop_last") %>% 
    mutate(month = paste0("s", month)) %>% 
    unite(col = "Var", .model, month, sep = "_") %>% 
    spread(Var, season_avg) %>% 
    mutate(SSDI_s3to5 = (SSDI_s3 + SSDI_s4 + SSDI_s5)/3,
           SSI_s3to5  = (SSI_s3  + SSI_s4  + SSI_s5)/3,
           conc_s3to5 = (conc_s3 + conc_s4 + conc_s5)/3,
           
           SSDI_pattern1 = SSDI_s3 / SSDI_s8,
           SSI_pattern1  = SSI_s3  / SSI_s8,
           conc_pattern1 = conc_s3 / conc_s8,
           
           SSDI_pattern2 = SSDI_s3to5 / SSDI_s8,
           SSI_pattern2  = SSI_s3to5  / SSI_s8,
           conc_pattern2 = conc_s3to5 / conc_s8
           )

df_temp_monAvg_wide <-   
  df_temp_monAvg %>% 
  mutate(Month = paste0("tempF_", Month )) %>% 
  spread(Month, tempF) %>% 
  mutate(tempF_1to2 = (tempF_1 + tempF_2) / 2,
         tempF_7to8 = (tempF_7 + tempF_8) / 2 )


# df_emplyInd_share # ready to use

df_reg_pattern %<>% 
  left_join(df_temp_monAvg_wide, by = "State") %>% 
  left_join(df_emplyInd_share,   by = "State")

df_reg_pattern1 <-  
  df_reg_pattern %>% 
  filter(State %in% state.abb)

```


# run regression
```{r}


df_reg_pattern1 %>% 
   lm(SSDI_s3to5 ~ unemply_s1 + unemply_s2 + tempF_1to2, data = .) %>% 
   summary()

df_reg_pattern1 %>% 
   lm(SSI_s3to5 ~ unemply_s12 + unemply_s1 + unemply_s2 + tempF_1to2, data = .) %>% 
   summary()

df_reg_pattern1 %>% 
   lm(conc_s3to5 ~ unemply_s12 + unemply_s1 + unemply_s2 + tempF_1to2, data = .) %>% 
   summary()

# df_reg_pattern1 %>% 
#    lm(UIIC_s3to5 ~ unemply_s12 + unemply_s1 + unemply_s2 + tempF_1to2, data = .) %>% 
#    summary()


df_reg_pattern1 %>% 
   lm(SSDI_s8 ~ unemply_s7 + tempF_7to8, data = .) %>% 
   summary()

df_reg_pattern1 %>% 
   lm(SSI_s8  ~ unemply_s6 + unemply_s7 + tempF_7to8, data = .) %>% 
   summary()

df_reg_pattern1 %>% 
   lm(conc_s8 ~ unemply_s6 + unemply_s7 + tempF_7to8, data = .) %>% 
   summary()




```













